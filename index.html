<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PharmExpiry â€” Gestion des pÃ©remptions</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2d6a4f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PharmExpiry">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f0ede8;
    --surface: #faf9f7;
    --border: #d8d3ca;
    --text: #1a1916;
    --muted: #7a756c;
    --accent: #2d6a4f;
    --accent-light: #d8ead2;
    --warn: #b5541a;
    --warn-light: #fdebd8;
    --danger: #8b1a1a;
    --danger-light: #fde8e8;
    --ok: #2d6a4f;
    --ok-light: #d8ead2;
    --ink: #1a1916;
    --radius: 12px;
    --reserve: #2d6a4f;
    --reserve-light: #d8ead2;
    --stups: #8f3a3a;
    --stups-light: #f7dfdf;
    --malledc: #7a5a1a;
    --malledc-light: #f7f0dd;
    --vaccin: #1a6b7a;
    --vaccin-light: #d8f0f4;
    --vss: #1a6b8a;
    --vss-light: #d0eaf5;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 24px;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 1.5px solid var(--border);
  }

  .logo h1 { font-family: 'DM Serif Display', serif; font-size: 2.2rem; letter-spacing: -0.5px; }
  .logo span { color: var(--accent); }
  .logo p { font-size: 0.8rem; color: var(--muted); font-family: 'DM Mono', monospace; letter-spacing: 0.05em; text-transform: uppercase; margin-top: 2px; }

  .stats-bar { display: flex; gap: 20px; align-items: flex-end; flex-direction: column; }

  .stats-row { display: flex; gap: 20px; }

  .stat { text-align: right; }
  .stat .n { font-family: 'DM Serif Display', serif; font-size: 1.8rem; line-height: 1; }
  .stat .l { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; font-family: 'DM Mono', monospace; }
  .stat.warn .n { color: var(--warn); }
  .stat.danger .n { color: var(--danger); }

  /* â”€â”€ LIEUX BADGES â”€â”€ */
  .lieu-badge {
    display: inline-flex;
    align-items: center;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 0.72rem;
    font-family: 'DM Mono', monospace;
    font-weight: 600;
    letter-spacing: 0.04em;
    white-space: nowrap;
  }

  .lieu-Reserve  { background: var(--reserve-light); color: var(--reserve); }
  .lieu-Stups    { background: var(--stups-light); color: var(--stups); }
  .lieu-MalleDC  { background: var(--malledc-light); color: var(--malledc); }
  .lieu-Vaccin   { background: var(--vaccin-light); color: var(--vaccin); }
  .lieu-VSS      { background: var(--vss-light); color: var(--vss); }

  /* â”€â”€ ENCART AJOUT â”€â”€ */
  .add-card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 28px;
  }

  .add-card h2 { font-family: 'DM Serif Display', serif; font-size: 1.15rem; margin-bottom: 16px; }

  .voice-unsupported-msg {
    font-size: 0.82rem; color: var(--warn);
    font-family: 'DM Mono', monospace;
    background: var(--warn-light); border: 1px solid var(--warn);
    border-radius: 8px; padding: 8px 12px; margin-bottom: 12px;
  }

  .voice-btn {
    width: 64px; height: 64px; border-radius: 50%; border: none;
    background: var(--accent); color: white; font-size: 1.5rem;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(45,106,79,0.3);
  }
  .voice-btn:hover { transform: scale(1.05); }
  .voice-btn.recording { background: var(--danger); animation: pulse 1s infinite; }
  .voice-btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }

  .chain-btn {
    width: 64px; height: 64px; border-radius: 50%;
    border: 2px solid var(--border); background: var(--surface);
    color: var(--muted); font-size: 1.4rem;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; flex-shrink: 0;
    font-family: 'DM Sans', sans-serif; font-weight: 600;
  }
  .chain-btn:hover { border-color: var(--warn); color: var(--warn); }
  .chain-btn.chain-active {
    background: var(--warn); border-color: var(--warn);
    color: white; animation: pulse-chain 1.5s infinite;
    box-shadow: 0 4px 16px rgba(181,84,26,0.4);
  }

  @keyframes pulse-chain {
    0%,100% { box-shadow: 0 4px 16px rgba(181,84,26,0.3); }
    50%      { box-shadow: 0 4px 28px rgba(181,84,26,0.6); }
  }

  @keyframes pulse {
    0%,100% { box-shadow: 0 4px 20px rgba(139,26,26,0.4); }
    50% { box-shadow: 0 4px 32px rgba(139,26,26,0.7); }
  }

  .voice-area { display: flex; gap: 16px; align-items: flex-start; }
  .voice-fields { flex: 1; display: flex; flex-direction: column; gap: 10px; }

  .transcript-box {
    background: var(--bg); border: 1.5px solid var(--border);
    border-radius: 8px; padding: 12px;
    font-family: 'DM Mono', monospace; font-size: 0.85rem;
    color: var(--muted); min-height: 48px; transition: border-color 0.2s;
  }
  .transcript-box.active { border-color: var(--accent); color: var(--text); }

  .fields-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 10px; align-items: end;
  }

  label {
    display: block; font-size: 0.72rem; text-transform: uppercase;
    letter-spacing: 0.08em; font-family: 'DM Mono', monospace;
    color: var(--muted); margin-bottom: 5px;
  }

  input[type="text"], input[type="month"], input[type="date"], select {
    width: 100%; padding: 10px 12px;
    background: var(--bg); border: 1.5px solid var(--border);
    border-radius: 8px; font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem; color: var(--text); outline: none;
    transition: border-color 0.2s; -webkit-appearance: none; appearance: none;
  }

  select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%237a756c'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 10px center;
    padding-right: 28px;
  }

  input:focus, select:focus { border-color: var(--accent); }

  .btn {
    padding: 10px 20px; border: none; border-radius: 8px;
    font-family: 'DM Sans', sans-serif; font-size: 0.9rem;
    font-weight: 600; cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }

  .voice-hint { font-size: 0.78rem; color: var(--muted); font-style: italic; }

  /* â”€â”€ ONGLETS PRINCIPAUX â”€â”€ */
  .tabs {
    display: flex; gap: 0; margin-bottom: 24px;
    border-bottom: 2px solid var(--border);
  }

  .tab {
    padding: 10px 24px; border: none; background: transparent;
    font-family: 'DM Sans', sans-serif; font-size: 0.9rem;
    font-weight: 500; color: var(--muted); cursor: pointer;
    transition: all 0.2s; border-bottom: 2.5px solid transparent;
    margin-bottom: -2px; display: flex; align-items: center; gap: 7px;
  }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }
  .tab:not(.active):hover { color: var(--text); }

  .tab-badge {
    font-size: 0.68rem; font-family: 'DM Mono', monospace;
    background: var(--border); color: var(--muted);
    padding: 1px 7px; border-radius: 20px;
  }
  .tab.active .tab-badge { background: var(--accent-light); color: var(--accent); }

  /* â”€â”€ SECTIONS â”€â”€ */
  .section { display: none; }
  .section.active { display: block; }

  /* â”€â”€ ONGLETS LIEUX (sous-navigation) â”€â”€ */
  .lieu-tabs {
    display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;
  }

  .lieu-tab {
    padding: 8px 20px; border-radius: 8px;
    border: 1.5px solid var(--border);
    background: var(--surface);
    font-family: 'DM Sans', sans-serif; font-size: 0.85rem;
    font-weight: 500; color: var(--muted); cursor: pointer;
    transition: all 0.2s; display: flex; align-items: center; gap: 8px;
  }
  .lieu-tab:hover { border-color: var(--text); color: var(--text); }
  .lieu-tab.active-Reserve { background: var(--reserve); border-color: var(--reserve); color: white; }
  .lieu-tab.active-Stups   { background: var(--stups); border-color: var(--stups); color: white; }
  .lieu-tab.active-MalleDC { background: var(--malledc); border-color: var(--malledc); color: white; }
  .lieu-tab.active-Vaccin  { background: var(--vaccin); border-color: var(--vaccin); color: white; }
  .lieu-tab.active-VSS     { background: var(--vss); border-color: var(--vss); color: white; }
  .lieu-tab.active-all     { background: var(--ink); border-color: var(--ink); color: white; }

  .lieu-tab .count {
    font-size: 0.7rem; font-family: 'DM Mono', monospace;
    background: rgba(255,255,255,0.25); padding: 1px 6px; border-radius: 10px;
  }
  .lieu-tab:not([class*="active"]) .count {
    background: var(--bg); color: var(--muted);
  }

  /* â”€â”€ STOCK TABLE â”€â”€ */
  .stock-controls {
    display: flex; gap: 10px; margin-bottom: 16px;
    align-items: center; flex-wrap: wrap;
  }

  .search-input { flex: 1; min-width: 180px; }

  .sort-select {
    padding: 10px 32px 10px 12px; border: 1.5px solid var(--border);
    border-radius: 8px; font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem; background: var(--surface); color: var(--muted);
    outline: none; cursor: pointer; -webkit-appearance: none; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%237a756c'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 10px center;
    width: auto;
  }

  .stock-filters { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }

  .filter-pill {
    padding: 5px 14px; border-radius: 20px; border: 1.5px solid var(--border);
    background: transparent; font-size: 0.78rem; cursor: pointer;
    font-family: 'DM Sans', sans-serif; transition: all 0.15s; color: var(--muted);
  }
  .filter-pill.active      { background: var(--ink); border-color: var(--ink); color: white; }
  .filter-pill.f-expired.active { background: var(--danger); border-color: var(--danger); }
  .filter-pill.f-soon.active    { background: var(--warn); border-color: var(--warn); }
  .filter-pill.f-ok.active      { background: var(--ok); border-color: var(--ok); }

  /* RÃ©sumÃ© global */
  .global-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .summary-card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
  }

  .summary-card-title {
    font-size: 0.7rem; font-family: 'DM Mono', monospace;
    text-transform: uppercase; letter-spacing: 0.06em;
    margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
  }

  .summary-card-title .dot {
    width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  }
  .dot-Reserve { background: var(--reserve); }
  .dot-Stups   { background: var(--stups); }
  .dot-MalleDC { background: var(--malledc); }
  .dot-Vaccin  { background: var(--vaccin); }
  .dot-VSS     { background: var(--vss); }

  .summary-card-stats {
    display: flex; gap: 10px; flex-wrap: wrap;
  }

  .mini-stat { text-align: center; }
  .mini-stat .n { font-family: 'DM Serif Display', serif; font-size: 1.3rem; line-height: 1; }
  .mini-stat .l { font-size: 0.62rem; font-family: 'DM Mono', monospace; color: var(--muted); text-transform: uppercase; }
  .mini-stat.danger .n { color: var(--danger); }
  .mini-stat.warn .n { color: var(--warn); }

  .stock-table-wrap {
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: var(--radius); overflow: hidden;
  }

  .stock-table-header {
    padding: 14px 20px; border-bottom: 1.5px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    background: var(--bg);
  }
  .stock-table-header span { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }

  table { width: 100%; border-collapse: collapse; }
  thead th {
    text-align: left; padding: 10px 20px;
    font-size: 0.68rem; font-family: 'DM Mono', monospace;
    text-transform: uppercase; letter-spacing: 0.08em;
    color: var(--muted); border-bottom: 1px solid var(--border); background: var(--bg);
  }
  tbody td { padding: 12px 20px; font-size: 0.88rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tbody tr:last-child td { border-bottom: none; }
  tbody tr:hover td { background: #f5f3ef; }
  .td-name { font-weight: 600; }
  .td-date { font-family: 'DM Mono', monospace; font-size: 0.82rem; color: var(--muted); white-space: nowrap; }
  .td-actions { width: 80px; text-align: right; display: flex; gap: 6px; justify-content: flex-end; }

  /* â”€â”€ BOUTONS ACTION TABLE â”€â”€ */

  .med-del {
    width: 28px; height: 28px; border-radius: 6px;
    border: 1.5px solid transparent; background: transparent;
    cursor: pointer; color: var(--muted); font-size: 0.85rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; flex-shrink: 0;
  }
  .med-del:hover { border-color: var(--danger); color: var(--danger); background: var(--danger-light); }


  /* â”€â”€ VUE PAR MOIS â”€â”€ */
  .month-picker-bar {
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: var(--radius); padding: 18px 20px;
    margin-bottom: 20px; display: flex;
    align-items: center; gap: 14px; flex-wrap: wrap;
  }

  .month-nav-group { display: flex; align-items: center; gap: 8px; flex: 1; }

  .nav-btn {
    width: 34px; height: 34px; border-radius: 50%;
    border: 1.5px solid var(--border); background: var(--bg);
    cursor: pointer; font-size: 1rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; color: var(--text); flex-shrink: 0;
  }
  .nav-btn:hover { border-color: var(--accent); color: var(--accent); }

  .month-label-display {
    font-family: 'DM Serif Display', serif; font-size: 1.3rem;
    text-transform: capitalize; flex: 1; text-align: center;
  }

  .btn-today {
    padding: 6px 14px; border-radius: 20px;
    border: 1.5px solid var(--border); background: var(--bg);
    font-size: 0.75rem; font-family: 'DM Mono', monospace;
    cursor: pointer; transition: all 0.15s; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.06em; white-space: nowrap;
  }
  .btn-today:hover { border-color: var(--accent); color: var(--accent); }

  .month-actions {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 16px; flex-wrap: wrap; gap: 10px;
  }

  .month-summary { display: flex; gap: 8px; flex-wrap: wrap; }

  .summary-chip {
    padding: 5px 12px; border-radius: 20px;
    font-size: 0.78rem; font-family: 'DM Mono', monospace;
    display: flex; align-items: center; gap: 5px;
  }
  .chip-expired { background: var(--danger-light); color: var(--danger); }
  .chip-soon    { background: var(--warn-light); color: var(--warn); }
  .chip-ok      { background: var(--ok-light); color: var(--ok); }

  .btn-export {
    display: flex; align-items: center; gap: 8px; padding: 9px 18px;
    border: 1.5px solid var(--accent); border-radius: 8px;
    background: var(--accent-light); color: var(--accent);
    font-family: 'DM Sans', sans-serif; font-size: 0.85rem;
    font-weight: 600; cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .btn-export:hover { background: var(--accent); color: white; }

  /* â”€â”€ LISTE MEDS (vue mois) â”€â”€ */
  .med-list { display: flex; flex-direction: column; gap: 8px; }

  .med-item {
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: var(--radius); padding: 14px 18px;
    display: flex; align-items: center; gap: 12px;
    transition: all 0.15s; animation: slideIn 0.25s ease;
  }
  @keyframes slideIn { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }

  .med-item:hover { border-color: var(--accent); }
  .med-item.expired { border-color: var(--danger); background: var(--danger-light); }
  .med-item.soon    { border-color: var(--warn); background: var(--warn-light); }
  .med-item.ok      { border-left: 3px solid var(--ok); }

  .med-name { font-weight: 600; font-size: 0.95rem; flex: 1; }
  .med-date { font-family: 'DM Mono', monospace; font-size: 0.82rem; color: var(--muted); white-space: nowrap; }

  .med-badge {
    font-family: 'DM Mono', monospace; font-size: 0.72rem;
    padding: 3px 10px; border-radius: 20px; font-weight: 500; white-space: nowrap;
  }
  .badge-ok      { background: var(--ok-light); color: var(--ok); }
  .badge-soon    { background: var(--warn-light); color: var(--warn); }
  .badge-expired { background: var(--danger-light); color: var(--danger); }

  .med-del-round {
    width: 30px; height: 30px; border-radius: 50%;
    border: 1.5px solid transparent; background: transparent;
    cursor: pointer; color: var(--muted); font-size: 1rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; flex-shrink: 0;
  }
  .med-del-round:hover { border-color: var(--danger); color: var(--danger); background: var(--danger-light); }

  .empty-state {
    text-align: center; padding: 60px 20px; color: var(--muted);
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: var(--radius);
  }
  .empty-state .icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.4; }
  .empty-state p { font-size: 0.88rem; }

  /* â”€â”€ TOAST â”€â”€ */
  .toast {
    position: fixed; bottom: 24px; right: 24px;
    background: var(--ink); color: white; padding: 12px 20px;
    border-radius: 10px; font-size: 0.85rem;
    font-family: 'DM Mono', monospace;
    transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 1000;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { background: var(--accent); }
  .toast.error   { background: var(--danger); }

  /* â”€â”€ PRINT â”€â”€ */
  .print-header { display: none; }
  .print-stats  { display: none; }

  @media print {
    body { background: white; padding: 0; }
    header, .add-card, .tabs, #section-stock, .month-picker-bar,
    .month-actions, .lieu-tabs, .toast, .med-del-round { display: none !important; }
    #section-month { display: block !important; }
    .print-header { display: block !important; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 2px solid #1a1916; }
    .print-title { font-family: 'DM Serif Display', serif; font-size: 1.6rem; }
    .print-subtitle { font-size: 0.8rem; color: #7a756c; font-family: monospace; text-transform: uppercase; letter-spacing: 0.06em; margin-top: 4px; }
    .month-summary { margin-bottom: 16px; }
    .summary-chip { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .lieu-badge   { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .med-item { break-inside: avoid; border: 1px solid #d8d3ca !important; margin-bottom: 6px; padding: 10px 14px; }
    .med-item.expired { background: #fde8e8 !important; border-color: #8b1a1a !important; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .med-item.soon    { background: #fdebd8 !important; border-color: #b5541a !important; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .med-badge { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .empty-state { border: 1px solid #d8d3ca; }
    @page { margin: 20mm 15mm; }
  }

  /* â”€â”€ RESPONSIVE â”€â”€ */
  @media (max-width: 640px) {
    .stats-bar { display: none; }
    .fields-row { grid-template-columns: 1fr 1fr; }
    .fields-row > *:nth-child(3) { grid-column: 1 / -1; }
    .fields-row .btn { grid-column: 1 / -1; }
    body { padding: 12px; }
    .global-summary { grid-template-columns: 1fr; }
    .month-picker-bar { flex-direction: column; align-items: stretch; }
    .month-nav-group { justify-content: center; }

    /* Masquer le tableau sur mobile */
    .stock-table-wrap table { display: none; }

    /* Cartes mobiles */
    .stock-cards { display: flex; flex-direction: column; gap: 8px; padding: 12px; }

    .stock-card {
      background: var(--surface);
      border-radius: 10px;
      border: 1.5px solid var(--border);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .stock-card.expired { border-color: var(--danger); background: var(--danger-light); }
    .stock-card.soon    { border-color: var(--warn);   background: var(--warn-light); }

    .stock-card-top {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stock-card-name {
      font-weight: 700;
      font-size: 0.95rem;
      flex: 1;
    }
    .stock-card-bottom {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .stock-card-date {
      font-family: 'DM Mono', monospace;
      font-size: 0.78rem;
      color: var(--muted);
      flex: 1;
    }
    .stock-card-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-left: auto;
    }
    .tab { padding: 10px 14px; font-size: 0.82rem; }
  }

  /* Sur desktop, masquer les cartes mobiles */
  @media (min-width: 641px) {
    .stock-cards { display: none; }
  }

  /* â”€â”€ EXPORT / IMPORT â”€â”€ */
  .backup-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
  }

  .backup-bar-label {
    font-size: 0.72rem;
    font-family: 'DM Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--muted);
    margin-right: 4px;
  }

  .btn-backup {
    display: flex; align-items: center; gap: 6px;
    padding: 7px 14px; border-radius: 8px;
    font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 600;
    cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }

  .btn-export-json {
    border: 1.5px solid var(--accent);
    background: var(--accent-light); color: var(--accent);
  }
  .btn-export-json:hover { background: var(--accent); color: white; }

  .btn-import-json {
    border: 1.5px solid var(--border);
    background: var(--surface); color: var(--muted);
  }
  .btn-import-json:hover { border-color: var(--text); color: var(--text); }

  .btn-detect-dupes {
    border: 1.5px solid var(--warn);
    background: var(--warn-light); color: var(--warn);
  }
  .btn-detect-dupes:hover { background: var(--warn); color: white; }

  /* â”€â”€ MODAL GÃ‰NÃ‰RIQUE â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(26,25,22,0.5);
    display: flex; align-items: center; justify-content: center;
    z-index: 500; padding: 20px;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--surface); border-radius: var(--radius);
    padding: 28px; width: 100%; max-width: 400px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    transform: translateY(16px); transition: transform 0.2s;
  }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal h3 { font-family: 'DM Serif Display', serif; font-size: 1.2rem; margin-bottom: 6px; }
  .modal .med-info { font-size: 0.82rem; color: var(--muted); font-family: 'DM Mono', monospace; margin-bottom: 4px; }
  .modal-fields { display: flex; flex-direction: column; gap: 14px; margin-bottom: 20px; }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
  .btn-cancel {
    padding: 9px 18px; border: 1.5px solid var(--border);
    border-radius: 8px; background: transparent;
    font-family: 'DM Sans', sans-serif; font-size: 0.88rem;
    color: var(--muted); cursor: pointer; transition: all 0.15s;
  }
  .btn-cancel:hover { border-color: var(--text); color: var(--text); }

  .dupe-group {
    background: var(--warn-light); border: 1.5px solid var(--warn);
    border-radius: 10px; padding: 12px 14px;
  }
  .dupe-group-title {
    font-weight: 700; font-size: 0.88rem; margin-bottom: 8px;
    display: flex; align-items: center; gap: 6px;
  }
  .dupe-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 6px 0; border-top: 1px solid rgba(181,84,26,0.2);
    font-size: 0.83rem; gap: 8px;
  }
  .dupe-item:first-of-type { border-top: none; }
  .dupe-lieu { font-family: 'DM Mono', monospace; font-size: 0.72rem; color: var(--warn); }
  .dupe-date { font-family: 'DM Mono', monospace; font-size: 0.72rem; color: var(--muted); flex:1; }
</style>
</head>
<body>

<!-- â•â• HEADER â•â• -->
<header>
  <div class="logo">
    <h1>Pharm<span>Expiry</span></h1>
    <p>Gestion des dates de pÃ©remption</p>
  </div>
  <div class="stats-bar">
    <div class="stats-row">
      <div class="stat danger" id="stat-expired"><div class="n">0</div><div class="l">PÃ©rimÃ©s</div></div>
      <div class="stat warn"   id="stat-soon">   <div class="n">0</div><div class="l">BientÃ´t</div></div>
      <div class="stat"        id="stat-total">  <div class="n">0</div><div class="l">Total</div></div>
    </div>
  </div>
</header>

<!-- â•â• BARRE SAUVEGARDE â•â• -->
<div class="backup-bar">
  <span class="backup-bar-label">ğŸ’¾ Sauvegarde</span>
  <button class="btn-backup btn-export-json" onclick="exportJSON()">â¬‡ JSON</button>
  <button class="btn-backup btn-import-json" onclick="document.getElementById('importFile').click()">â¬† JSON</button>
  <button class="btn-backup btn-detect-dupes" onclick="detectDuplicates()">ğŸ” Doublons</button>
  <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importJSON(event)">
</div>

<!-- â•â• MODAL DOUBLONS â•â• -->
<div class="modal-overlay" id="dupesOverlay" onclick="if(event.target===this) closeDupesModal()">
  <div class="modal" style="max-width:520px; max-height:80vh; display:flex; flex-direction:column;">
    <h3>ğŸ” Doublons dÃ©tectÃ©s</h3>
    <div class="med-info" id="dupesInfo"></div>
    <div id="dupesList" style="overflow-y:auto; flex:1; margin: 16px 0; display:flex; flex-direction:column; gap:10px;"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeDupesModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- â•â• ENCART AJOUT â•â• -->
<div class="add-card">
  <h2>ğŸ¤ Ajouter un mÃ©dicament</h2>
  <div id="voiceUnsupportedMsg" class="voice-unsupported-msg" style="display:none;">
    ğŸ¤ La dictÃ©e vocale n'est pas disponible sur ce navigateur.
  </div>
  <div class="voice-area">
    <button class="voice-btn" id="voiceBtn" title="DictÃ©e vocale">ğŸ¤</button>
    <button class="chain-btn" id="chainBtn" title="Mode chaÃ®ne â€” dicte plusieurs mÃ©dicaments d'affilÃ©e">â›“</button>
    <div class="voice-fields">
      <div class="transcript-box" id="transcript">Appuyez sur ğŸ¤ et dites par exemple : "Doliprane 1000 pÃ©remption mars 2026"</div>
      <div class="fields-row">
        <div>
          <label>MÃ©dicament</label>
          <input type="text" id="medName" placeholder="Nom du mÃ©dicament" autocomplete="off" list="medSuggestions">
          <datalist id="medSuggestions"></datalist>
        </div>
        <div>
          <label>Date de pÃ©remption</label>
          <input type="date" id="medDate">
        </div>
        <div>
          <label>Lieu</label>
          <select id="medLieu">
            <option value="Reserve">RÃ©serve/SDS/Bio</option>
            <option value="VSS">VSS</option>
            <option value="Stups">Stups</option>
            <option value="MalleDC">Malle DC</option>
            <option value="Vaccin">Vaccin</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="addMed()">+ Ajouter</button>
      </div>
      <p class="voice-hint" id="voiceHint">ğŸ’¡ Dites : "Doliprane 500 pÃ©remption janvier 2027"</p>
    </div>
  </div>
</div>

<!-- â•â• ONGLETS PRINCIPAUX â•â• -->
<div class="tabs">
  <button class="tab active" id="tab-stock" onclick="switchTab('stock')">
    ğŸ“¦ Stock total <span class="tab-badge" id="badge-stock">0</span>
  </button>
  <button class="tab" id="tab-month" onclick="switchTab('month')">
    ğŸ“… Par mois <span class="tab-badge" id="badge-month">â€”</span>
  </button>
</div>

<!-- â•â•â•â•â•â• ONGLET STOCK TOTAL â•â•â•â•â•â• -->
<div class="section active" id="section-stock">

  <!-- RÃ©sumÃ© global par lieu -->
  <div class="global-summary" id="globalSummary"></div>

  <!-- ContrÃ´les -->
  <div class="stock-controls">
    <input class="search-input" type="text" id="searchStock" placeholder="ğŸ” Rechercher dans le stockâ€¦" oninput="renderStock()">
    <select class="sort-select" id="sortStock" onchange="renderStock()">
      <option value="status">Urgence d'abord</option>
      <option value="date-asc">Date la plus proche</option>
      <option value="date-desc">Date la plus lointaine</option>
      <option value="name-asc">Nom A â†’ Z</option>
      <option value="name-desc">Nom Z â†’ A</option>
      <option value="lieu">Par lieu</option>
    </select>
  </div>

  <!-- Filtres statut -->
  <div class="stock-filters">
    <button class="filter-pill active"    onclick="setStockFilter('all', this)">Tout</button>
    <button class="filter-pill f-expired" onclick="setStockFilter('expired', this)">ğŸ”´ PÃ©rimÃ©s</button>
    <button class="filter-pill f-soon"    onclick="setStockFilter('soon', this)">ğŸŸ  BientÃ´t (â‰¤30j)</button>
    <button class="filter-pill f-ok"      onclick="setStockFilter('ok', this)">ğŸŸ¢ OK</button>
  </div>

  <!-- Filtre lieu -->
  <div class="lieu-tabs" id="lieuTabs">
    <button class="lieu-tab active-all" onclick="setLieuFilter('all', this)">
      Tous <span class="count" id="count-all">0</span>
    </button>
    <button class="lieu-tab" onclick="setLieuFilter('Reserve', this)">
      RÃ©serve/SDS/Bio <span class="count" id="count-Reserve">0</span>
    </button>
    <button class="lieu-tab" onclick="setLieuFilter('VSS', this)">
      VSS <span class="count" id="count-VSS">0</span>
    </button>
    <button class="lieu-tab" onclick="setLieuFilter('Stups', this)">
      Stups <span class="count" id="count-Stups">0</span>
    </button>
    <button class="lieu-tab" onclick="setLieuFilter('MalleDC', this)">
      Malle DC <span class="count" id="count-MalleDC">0</span>
    </button>
    <button class="lieu-tab" onclick="setLieuFilter('Vaccin', this)">
      Vaccin <span class="count" id="count-Vaccin">0</span>
    </button>
  </div>

  <!-- Tableau -->
  <div class="stock-table-wrap">
    <div class="stock-table-header">
      <span id="stockCountLabel">0 mÃ©dicament</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>MÃ©dicament</th>
          <th>Lieu</th>
          <th>Date pÃ©remption</th>
          <th>Statut</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="stockBody"></tbody>
    </table>
    <div class="stock-cards" id="stockCards"></div>
    <div id="stockEmpty" class="empty-state" style="display:none;">
      <div class="icon">ğŸ“¦</div><p>Aucun mÃ©dicament dans le stock.</p>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• ONGLET PAR MOIS â•â•â•â•â•â• -->
<div class="section" id="section-month">

  <div class="print-header">
    <div class="print-title">Pharm<span style="color:#2d6a4f">Expiry</span> â€” PÃ©remptions du mois</div>
    <div class="print-subtitle" id="printSubtitle"></div>
  </div>

  <div class="month-picker-bar">
    <label>Mois Ã  afficher</label>
    <div class="month-nav-group">
      <button class="nav-btn" onclick="changeMonth(-1)">â€¹</button>
      <div class="month-label-display" id="monthLabel"></div>
      <button class="nav-btn" onclick="changeMonth(1)">â€º</button>
    </div>
    <input style="padding:8px 12px;width:auto;font-size:0.85rem;" type="month" id="monthPicker" onchange="onMonthPick()">
    <button class="btn-today" onclick="goToToday()">Ce mois-ci</button>
  </div>

  <!-- Filtre lieu dans vue mois aussi -->
  <div class="lieu-tabs" id="lieuTabsMonth">
    <button class="lieu-tab active-all" onclick="setLieuFilterMonth('all', this)">Tous</button>
    <button class="lieu-tab" onclick="setLieuFilterMonth('Reserve', this)">RÃ©serve/SDS/Bio</button>
    <button class="lieu-tab" onclick="setLieuFilterMonth('VSS', this)">VSS</button>
    <button class="lieu-tab" onclick="setLieuFilterMonth('Stups', this)">Stups</button>
    <button class="lieu-tab" onclick="setLieuFilterMonth('MalleDC', this)">Malle DC</button>
    <button class="lieu-tab" onclick="setLieuFilterMonth('Vaccin', this)">Vaccin</button>
  </div>

  <div class="month-actions">
    <div class="month-summary" id="monthSummary"></div>
    <button class="btn-export" onclick="exportPDF()" id="btnExport" style="display:none;">â¬‡ Exporter en PDF</button>
  </div>

  <div class="med-list" id="medList"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STORAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let meds = [];

function loadData() {
  try {
    // Essaie d'abord la clÃ© actuelle
    let raw = localStorage.getItem('pharmExpiry_v2');

    // Migration depuis les anciennes clÃ©s si rien trouvÃ©
    if (!raw) raw = localStorage.getItem('pharmExpiry');
    if (!raw) raw = localStorage.getItem('pharmExpiry_v1');

    if (raw) {
      meds = JSON.parse(raw);
      // Migration : ajoute lieu par dÃ©faut si absent
      meds = meds.map(m => ({ lieu: 'Reserve', ...m }));
      // Sauvegarde sous la nouvelle clÃ©
      localStorage.setItem('pharmExpiry_v2', JSON.stringify(meds));
    } else {
      meds = [];
    }
  } catch(e) { meds = []; }
}

function save() {
  try { localStorage.setItem('pharmExpiry_v2', JSON.stringify(meds)); updateSuggestions(); }
  catch(e) { toast('âš ï¸ Stockage non disponible', 'error'); }
}

function updateSuggestions() {
  const dl = document.getElementById('medSuggestions');
  if (!dl) return;
  // Combine saved names + known names from JSON, deduplicate, sort
  const savedNames = meds.map(m => m.name);
  const all = [...new Set([...savedNames, ...KNOWN_NAMES])].sort((a, b) => a.localeCompare(b, 'fr'));
  dl.innerHTML = all.map(n => `<option value="${n.replace(/"/g,'&quot;')}">`).join('');
}

loadData();
updateSuggestions();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentTab        = 'stock';
let stockFilter       = 'all';
let lieuFilter        = 'all';
let lieuFilterMonth   = 'all';
let currentMonth      = new Date();

const KNOWN_NAMES = ["Abaisse-langue", "Adaptateur de prise de sang pour cathÃ©ter", "Adaptateur prise de sang bleu", "AdrÃ©naline", "Agrafeuse", "Agrafeuse cutanÃ©e", "Aiguille de mÃ©sothÃ©rapie", "Aiguille de prÃ©lÃ¨vement type HÃ©lette", "Aiguille de prÃ©lÃ¨vement verte", "Aiguille de prÃ©lÃ¨vement Ã  ailettes", "Aiguille de prÃ©lÃ¨vement Ã  HÃ©lette", "Aiguille IM verte", "Aiguille IV noir", "Aiguille PIO bleu", "Aiguille PIO jaune", "Aiguille PIO rose", "Aiguille prise de sang ponction franche", "Aiguille prise de sang verte", "Aiguille sous cutanÃ©e orange", "Aiguille sous-cutanÃ©e jaune", "Aiguilles intramusculaire", "Alcool", "Alcool modifiÃ©", "Alcool modifiÃ© pÃ©ri", "AlÃ¨se absorbant", "AMOXICI2LINE", "Amoxicilline 500 mg", "AQUACEL de 2,5 cm par 48 cm", "Aquacell", "ASPEGIC 500 mg", "ASPEGIC 500 mg Peros", "ASPEGIC injectables", "ATROPINE", "Au stÃ©rile", "AUGMENTIN", "Augmentin", "Auto piqueur", "Bain de bouche Ã  la chlorhexidine", "Banc de cohÃ©sif de contention 10 cm par 2,25 m", "Bande adhÃ©sif Ã©lastique TENSOPLAST 15 cm par 2,5 m pÃ©ri", "Bande adhÃ©sive cohÃ©sive 7,5 cm par 4,5 m", "Bande adhÃ©sive Ã©lastique 10 cm par 2,5 m", "Bande adhÃ©sive Ã©lastique 15 cm par 2,5 m", "Bande adhÃ©sive Ã©lastique 6 cm par 2,5 m", "Bande adhÃ©sive Ã©lastique STRAPPAL4 cm par 10 m", "Bande adhÃ©sive Ã©lastique TENSOPLAST 10 cm par 2,5 m", "Bande adhÃ©sive Ã©lastique TENSOPLAST6 cm par 2,5 m", "Bande adhÃ©sive Ã©lastique TENSOPLAST6 cm par 2,5 m pÃ©ri", "Bande cohÃ©sif 7,5 cm par 2m", "Bande cohÃ©sive", "Bande cohÃ©sive 7,5 cm par 2 m", "Bande cohÃ©sive 7,5 cm par 4,5 m", "Bande crÃªpe quatre par 10 cm", "Bande crÃªpes quatre par 7 cm", "Bande crÃªpes quatre par 7cm", "Bande d'extensible blanche de 7 cm par 4 m", "Bande de crÃªpes 4 m par 10 cm", "Bande de crÃªpes 4 m par 7 cm", "Bande de crÃªpes de 4 m par 10 cm", "Bande de crÃªpes de 4 m par 7 cm", "Bande de crÃªpes de 7 cm par 4 m", "Bande de crÃªpes quatre par 10 cm", "Bande de crÃªpes quatre par 7 cm", "Bande de fixation cohÃ©sive de 10 cm par 2 m", "Bande de fixation cohÃ©sive de 10 cm par 4 m", "Bande de gaz", "Bande de gaz OPRACLEAN de 2 cm par 5 m", "Bande extensible 4 m par 10 cm", "Bande extensible 4 m par 7 cm", "Bande extensible 7,5 cm par 4 m", "Bande extensible blanche de 10 cm par 4 m", "Bande extensible blanche de 4 m par 10 cm", "Bande Ã©lastique cohÃ©sive de 2,5 cm par 2 m", "Bande Ã©lastique cohÃ©sive de 7,5 cm par 4,5 m", "Bande Ã©lastique de contention de 3 m par 7 cm pÃ©ri", "Bandelette glycÃ©mie", "Bandelette lactate", "Bandelette urinaire", "BAVU", "BAVU adulte", "BAVU pÃ©diatrique", "BETAMETHASONE", "Bistouri", "Bonne crÃªpe quatre par 10 cm", "Bouchon Lovenox", "Bouchon rouge", "Bouchons rouge", "BRILIQUE", "Burn shield 10 par 10 cm", "Burn shield 20 par 20 cm", "BURNSHIELD 10 cm par 10 cm pÃ©ri", "BURNSHIELD 20 cm par 20 cm", "BURNSHIELD facial", "BÃ¢ton ophtalmique", "BÃ©tadine", "BÃ©tadine alcoolique", "BÃ©tadine alcoolique 10 ml", "BÃ©tadine gel", "Calcitonine", "Canule bleu", "Canule grise", "Canule intra rectal", "Canule jaune", "Canule rouge", "Canule rouge 1er", "Capteur ETCO2 EMMA", "CEF TRIAXONE", "CEFTRIAXONE", "Ceinture pelvienne", "CERULYSE", "CETIRIZINE", "Cette ablation de suture", "Champ stÃ©rile 1er", "Champ stÃ©rile fenÃªtre", "Champ stÃ©riles", "Champ stÃ©riles non fenÃªtre", "Champ stÃ©riles non fenÃªtres", "Chant stÃ©riles fenÃªtre", "ChloraPrep", "Chlorhexidine", "Chlorhexidine bain de bouche", "Chlorure de sodium 100 ml", "Chlorure de sodium 250 ml", "CIPROFLOXACINE", "Circuit d'Ã©vacuation des gaz MEOPA", "Circuit d'Ã©vacuation MEOPA", "Circuit MEOPA adulte", "Circuit respirateur adulte", "Circuit respirateur pÃ©diatrique", "Ciseaux stÃ©rile", "Ciseaux stÃ©riles", "CODOLIPRANE", "COLDPACK", "Colle pour suture cutanÃ©e", "Colle tissulaire", "Collecteur Ã  urine", "Compeed", "Compresse non stÃ©rile", "Compresse non stÃ©riles", "Compresse stÃ©rile", "Compresse stÃ©riles", "Compresses non stÃ©riles", "CORDARONE", "CORTANCYL", "Couverture de rÃ©chauffement active", "Covid", "CrÃ¨me solaire", "Cupule", "Curette", "Cyanokit", "CYANOKIT", "DACRYOSERUM", "DAKIN", "Dakin", "DIAZEPAM", "Diclofenac gel", "DIOMECTITE", "DIPHOTERINE", "Doigtier", "DoigtiÃ©", "Doliprane", "DOXYCYCLINE", "DUODERM de 6 cm par 11 cm", "Duoderme", "Eau oxygÃ©nÃ©e", "Eau oxygÃ©nÃ©e 10 ml", "Eau stÃ©rile", "ECONAZOLE poudre", "ELUDRIL bain de bouche", "ENGERIXB", "EOSINE", "ETHILON 2-0", "EXACYL", "Fil de suture 20 taille", "Fil de suture 60 taille", "Fil de suture deuxâ€“zÃ©ro", "Fil de suture quatreâ€“zÃ©ro", "Fil de suture sixâ€“zÃ©ro", "File de suture 20 taille", "File de suture 30 taille", "File de suture cinqâ€“zÃ©ro", "Fils de suture", "Filtre respirateur", "Filtre respirateur adulte 1er", "Filtre respirateur pÃ©diatrique", "Flammazine", "Floroglucinol Spasfon", "Floroglucinole Spasfon", "FLUMAZENIL", "FLUORESCEINE", "G 30 %", "G 30 % injectables", "G10 % injectables", "Gant taille M", "Gant taille M pÃ©ri", "Gant taille S", "Gants stÃ©rile 8,5 taille", "Gants stÃ©rile taille 7,5", "Gants stÃ©rile taille 8,5", "Gants stÃ©riles 6,5 taille", "Gants stÃ©riles taille 6,5", "Gants stÃ©riles taille 7,5", "Gants taille L", "Gants taille M", "Gants taille S", "Gants taille XL", "Gants Taille XL", "Gel anti adhÃ©sif", "GEL anti adhÃ©sif", "Gel FLECTOR", "Gel hydroalcoolique", "Gel hydroalcoolique grand modÃ¨le", "Gel hydroalcoolique petit modÃ¨le", "Gel l'hydroalcoolique", "Gel Ã©chographie flacon", "Gel Ã©chographie uni dose", "GELCAT Unidose", "GELOX", "Glucose 5 % 50 ml injectables", "HEPARINE injectables", "IPRATROPIUM adulte", "IPRATROPIUM pÃ©diatrique", "IPRATROPUIM 0,5 mg", "ISOCARD", "ISOFUNDINE 500 ml", "Jelonet 10 cm par 10 cm", "Jelonet 10 par", "Jelonet 5 cm", "JELONET de 10 cm par 10 cm", "JELONET5 cm par 5 cm", "KETAMINE", "KETOPROFENE 100 mg", "Ketoprofene 100 mg", "KETOPROFENE injectable", "KETOPROFENE injectables", "Kit de pansement", "Kit de suture", "Kit pansement", "KT bleu", "KT gris", "KT jaune", "KT Rose", "KT rose", "KT Rose 1er", "KT vers", "KT vert", "Lame d'intubation mil1", "Lames de tondeuse", "LIDOCAINE", "LIDOCAINE injectables", "LIDOCAINE pulvÃ©risation buccale", "LidocaÃ¯ne buccale", "Lingettes dÃ©sinfectante", "Lingettes dÃ©sinfectantes", "Lingettes Pampers", "LOVENOX 4000 UI", "Lovenox 4000 unitÃ©s", "LOXAPAC", "Lunettes Ã  oxygÃ¨ne adulte", "Lunettes Ã  oxygÃ¨ne pÃ©diatrique", "Mac4", "Mandrain souple d'intubation", "Masque chirurgical", "Masque FFP trois", "Masque haute concentration adulte", "Masque inhalateur pÃ©diatrique", "Masque jaune MEOPA", "Masque MEOPA blanc", "Masque MEOPA gris", "Masque MEOPA jaune", "Masque MEOPA vert", "Masque nÃ©bulisateurs adulte", "Masque oxygÃ¨ne haute concentration taille adulte", "Masque pour nÃ©bulisation adulte", "Masque pour nÃ©bulisation pÃ©diatrique", "Masque vert MEOPA", "Masque Ã  oxygÃ¨ne adulte haute concentration", "Masque Ã  oxygÃ¨ne haute concentration adulte", "Masque Ã  oxygÃ¨ne haute concentration pÃ©diatrique", "MEOPA", "MEPILEX 10 cm par 10cm", "Mepilex 10 cm par 25 cm", "MePilex border", "MESOCAINE", "METHYLPREDNISOLONE", "METOCLOPRAMIDE", "Metopilazine vogalÃ¨ne", "Micro cuvette HEMOCUE", "MIDAZOLAM 5 mg", "MIDAZOLAM 50 mg", "MMRVAX pro", "MORPHINE", "MÃ¨che hÃ©mostatique cicatrisante COALGAN", "MÃ¨che hÃ©mostatique cicatrisante de 40 cm", "MÃ¨che nasale", "NALOXONE", "NIMENRIX", "NORADRENALINE", "OPSITE adulte", "OPSITE pÃ©diatrique", "OPTILUBE", "Optiskin", "OPTISKIN 10 cm par 9cm", "OPTISKIN 10 par 9,20 cm", "OPTISKIN 5,3 par 8 cm", "OROZUMADOLE", "OxygÃ¨ne", "OXYNORM orodispersible", "PANOTILE", "Pansement absorbant", "Pansement absorbant de 15 cm par 20 cm", "Pansement absorbant de 20 cm par 40 cm", "Pansement adhÃ©sif stÃ©rile 10 cm par 20 cm", "Pansement alevin", "Pansement ALL EVYN rectangulaire 10 cm par 10 cm pÃ©ri", "Pansement ALLEVYN 10 cm par 20 cm", "Pansement ALLEVYN en Ã©toile", "Pansement amÃ©ricain 20 cm par 40 cm", "Pansement compressif d'urgence", "Pansement hydro colloÃ¯des 6 cm par 11 cm 1er", "Pansement lecomed", "Pansement LEUKOMED 5 cm par 7,2 cm 1er", "Pansement LEUKOMED de 5 cm par 7,2 cm pÃ©ri", "Pansement MEPILEX 10 cm par 10 cm", "Pansement MEPILEX 10 cm par 25 cm", "Pansement MEPILEX 7,8 cm par 10 cm", "Pansement MEPILEX carrÃ©", "Pansement MEPILEX carrÃ© grand modÃ¨le", "Pansement MEPILEX oval", "Pansement MEPILEX ovale", "Pansement MEPILEX rectangulaire grand modÃ¨le", "Pansement MÃ©talline", "Pansement OPTISKIN de 10 cm par 9 cm", "Pansement OPTISKIN de 5,3 cm par 8 cm", "Pansement plaie soufflante", "Pansement pour perfusion transparent", "Pansement pour plaie soufflante", "Pansement Sylaplaie", "Pansement SYLAPLAIE de 10 cm par 20 cm pÃ©ri", "PANTOPRAZOLE 20 mg", "PANTORRAZOLE 20 mg", "ParacÃ©tamol injectable", "Patch DSA", "Patch DSA adulte", "Patch DSA pÃ©diatrique", "Patch ECG", "Penthrox", "Perfuser", "Perfuseur", "PHLOROGLUCINOL", "PHLOROGLUCINOL injectables", "Pince de MAGILL 200 mm", "Pince de MAGILL 250 mm", "Pince de saturation pÃ©diatrique", "Pince enlÃ¨ve agrafes", "Pince haute agrafes", "Pince hÃ©mostatique le riche", "Pince hÃ©mostatique Leriche", "Pince le riche", "Pince Ã  dissection fine", "Pince Ã  dissection plate", "PIROXICAM injectables", "PLAVIX", "Poche de froid", "Poche de recueil ACCUVAC", "Poche Ã  urine", "POLARAMINE", "POLARAMINE injectables", "Pommade de vitamines A", "PREDNISONE 20 mg", "PRIMPERAN", "Prolongateur Octopus", "PrÃ©servatif", "PYOSTACINE", "QUANTIFERON", "QUICKCLOAT", "QUICKCLOT", "Raccord annelÃ©", "RACECADOTRIL", "Racecadotril tiorfan 100 mg", "REPEVAX", "RIFADINE", "RIFAMPICINE", "Ringer lactate 500 ml", "RINGER LACTATE 500 ml", "RINGER lactates 500 ml injectables", "RISORDAN", "RIVOTRIL", "Robinet 3 voie", "Robinet trois voies", "Rouleaux de sparadrap", "ROVAMYCINE", "SALBUTAMOL 5 mg", "SALBUTAMOL inhaler", "SALBUTAMOL inhalÃ©", "Savon doux", "Savon doux pour les mains", "Savon liquide 10 ml", "Savon main", "Seringue 10 ml", "Seringue 10 ml Ã ", "Seringue 20 ml", "Seringue 3 ml", "Seringue 5 ml", "Seringue 50 ml", "Seringue intra nasale", "Seringue NACL prÃ© rempli", "Set ablation de suture", "SET de suture", "SET pour pansement stÃ©rile", "SMECTA", "Sonde d'aspiration BUCO 26", "Sonde d'aspiration FR 06", "Sonde d'aspiration FR 10", "Sonde d'aspiration FR 18", "Sonde d'aspiration FR08", "Sonde d'aspiration FR12", "Sonde d'intubation taille 3,5", "Sonde d'intubation taille 4", "Sonde d'intubation taille 5,5", "Sonde d'intubation taille 6,0", "Sonde d'intubation taille cinq", "Sonde d'intubation taille quatre", "Sonde de tempÃ©rature nasaux pharyngÃ©", "Sonde de tempÃ©rature rectal", "Sonde gastrique  FR14", "Sonde gastrique FR 06", "Sonde gastrique FR 18", "Sonde IOT 6.5", "Sonde IOT 7", "Sonde IOT 7.5", "Sonde IOT 8 taille", "Sonde IOT taille 2,5", "Sonde IOT taille 4,5", "Sonde IOT taille trois", "SPASFON injectables", "Spray anti moustique", "Spray surface Safe", "STERISTRIP", "Strap 15 cm par 2,5 m", "Strap 4 cm par 10 m", "Strap 6 cm par 2,5 m", "Stylo d'exsufflation", "Stylo dÃ©mographique", "Stylo dÃ©rmographique", "StÃ©rile strip", "StÃ©riles strip", "SÃ©rum physiologique 100 ml", "SÃ©rum physiologique 100 ml injectables", "SÃ©rum physiologique 20 ml", "SÃ©rum physiologique 250 ml", "SÃ©rum physiologique 250 ml injectables", "SÃ©rum physiologique 5 ml", "SÃ©rum physiologique 50 ml", "SÃ©rum physiologique 500 ml", "SÃ©rum physiologique 5ml", "SÃ©rum physiologique injectables 500 ml", "Tegaderm", "TERBUTALINE 5 mg", "Test angine", "Test Covid", "Test de cancer du colo-rectal", "Test de dÃ©pistage colo-rectal", "Test de dÃ©pistage stupÃ©fiant", "Test de grossesse", "TICOVAC", "TOXICARB", "TROCARD", "Trocard", "Trocart", "Tubes jaune", "Tubes laryngÃ©e taille 2", "Tubes violet", "Tubulure ACCUVAC", "Tuyau d'Ã©vacuation de gaz MEOPA", "TYPHIM", "VAQTA", "VARILIX", "Vaseline", "VAXIGRIP", "VENTOLINE", "Ventoline", "Ã‰conazole poudre", "Ã‰osine aqueuse"];

const LIEUX = ['Reserve', 'VSS', 'Stups', 'MalleDC', 'Vaccin'];
const LIEU_LABELS = { Reserve: 'RÃ©serve/SDS/Bio', VSS: 'VSS', Stups: 'Stups', MalleDC: 'Malle DC', Vaccin: 'Vaccin' };

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TABS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  currentTab = tab;
  document.getElementById('section-stock').classList.toggle('active', tab === 'stock');
  document.getElementById('section-month').classList.toggle('active', tab === 'month');
  document.getElementById('tab-stock').classList.toggle('active', tab === 'stock');
  document.getElementById('tab-month').classList.toggle('active', tab === 'month');
  if (tab === 'stock') renderStock();
  else renderMonth();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TOAST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast ' + type; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATUS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getStatus(dateStr) {
  const today = new Date(); today.setHours(0,0,0,0);
  const diff = Math.floor((new Date(dateStr + 'T00:00:00') - today) / 86400000);
  return diff < 0 ? 'expired' : diff <= 30 ? 'soon' : 'ok';
}

function getDiff(dateStr) {
  const today = new Date(); today.setHours(0,0,0,0);
  return Math.floor((new Date(dateStr + 'T00:00:00') - today) / 86400000);
}

function badgeLabel(status, dateStr) {
  const diff = getDiff(dateStr);
  if (status === 'expired') return `PÃ©rimÃ© il y a ${Math.abs(diff)}j`;
  if (status === 'soon')    return `Dans ${diff}j`;
  return `OK â€” ${diff}j`;
}

function statusOrder(s) { return s === 'expired' ? 0 : s === 'soon' ? 1 : 2; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATS HEADER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
  let expired = 0, soon = 0;
  meds.forEach(m => {
    const s = getStatus(m.date);
    if (s === 'expired') expired++;
    if (s === 'soon')    soon++;
  });
  document.querySelector('#stat-expired .n').textContent = expired;
  document.querySelector('#stat-soon .n').textContent    = soon;
  document.querySelector('#stat-total .n').textContent   = meds.length;
  document.getElementById('badge-stock').textContent     = meds.length;

  // Compteurs lieu tabs
  LIEUX.forEach(l => {
    const el = document.getElementById('count-' + l);
    if (el) el.textContent = meds.filter(m => m.lieu === l).length;
  });
  const allEl = document.getElementById('count-all');
  if (allEl) allEl.textContent = meds.length;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GLOBAL SUMMARY (cartes par lieu)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGlobalSummary() {
  const container = document.getElementById('globalSummary');
  container.innerHTML = LIEUX.map(lieu => {
    const list = meds.filter(m => m.lieu === lieu);
    let exp = 0, soon = 0, ok = 0;
    list.forEach(m => { const s = getStatus(m.date); if(s==='expired') exp++; else if(s==='soon') soon++; else ok++; });
    return `
      <div class="summary-card">
        <div class="summary-card-title">
          <span class="dot dot-${lieu}"></span>
          ${LIEU_LABELS[lieu]} â€” ${list.length} mÃ©dicament${list.length>1?'s':''}
        </div>
        <div class="summary-card-stats">
          ${exp  ? `<div class="mini-stat danger"><div class="n">${exp}</div><div class="l">PÃ©rimÃ©s</div></div>` : ''}
          ${soon ? `<div class="mini-stat warn"><div class="n">${soon}</div><div class="l">BientÃ´t</div></div>` : ''}
          <div class="mini-stat"><div class="n">${ok}</div><div class="l">OK</div></div>
        </div>
      </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER STOCK
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStock() {
  updateStats();
  renderGlobalSummary();

  const search = document.getElementById('searchStock').value.toLowerCase();
  const sort   = document.getElementById('sortStock').value;

  let list = meds.filter(m => {
    if (!m.name.toLowerCase().includes(search)) return false;
    const s = getStatus(m.date);
    if (stockFilter !== 'all' && s !== stockFilter) return false;
    if (lieuFilter  !== 'all' && m.lieu !== lieuFilter) return false;
    return true;
  });

  list.sort((a, b) => {
    if (sort === 'status')    return statusOrder(getStatus(a.date)) - statusOrder(getStatus(b.date)) || new Date(a.date) - new Date(b.date);
    if (sort === 'date-asc')  return new Date(a.date) - new Date(b.date);
    if (sort === 'date-desc') return new Date(b.date) - new Date(a.date);
    if (sort === 'name-asc')  return a.name.localeCompare(b.name, 'fr');
    if (sort === 'name-desc') return b.name.localeCompare(a.name, 'fr');
    if (sort === 'lieu')      return LIEUX.indexOf(a.lieu) - LIEUX.indexOf(b.lieu) || new Date(a.date) - new Date(b.date);
    return 0;
  });

  const n = list.length;
  document.getElementById('stockCountLabel').textContent = `${n} mÃ©dicament${n > 1 ? 's' : ''}`;

  const tbody = document.getElementById('stockBody');
  const cards = document.getElementById('stockCards');
  const empty = document.getElementById('stockEmpty');

  if (list.length === 0) { tbody.innerHTML = ''; cards.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  tbody.innerHTML = list.map(m => {
    const s     = getStatus(m.date);
    const badge = badgeLabel(s, m.date);
    const date  = new Date(m.date + 'T00:00:00').toLocaleDateString('fr-FR', { day:'2-digit', month:'long', year:'numeric' });
    return `
      <tr>
        <td class="td-name">ğŸ’Š ${esc(m.name)}</td>
        <td><span class="lieu-badge lieu-${m.lieu}">${LIEU_LABELS[m.lieu]}</span></td>
        <td class="td-date">${date}</td>
        <td><span class="med-badge badge-${s}">${badge}</span></td>
        <td><div class="td-actions"><button class="med-del" onclick="deleteMed('${m.id}')" title="Supprimer">âœ•</button></div></td>
      </tr>`;
  }).join('');

  // Version cartes pour mobile
  cards.innerHTML = list.map(m => {
    const s     = getStatus(m.date);
    const badge = badgeLabel(s, m.date);
    const date  = new Date(m.date + 'T00:00:00').toLocaleDateString('fr-FR', { day:'2-digit', month:'short', year:'numeric' });
    return `
      <div class="stock-card ${s}">
        <div class="stock-card-top">
          <span class="stock-card-name">ğŸ’Š ${esc(m.name)}</span>
          <span class="lieu-badge lieu-${m.lieu}">${LIEU_LABELS[m.lieu]}</span>
        </div>
        <div class="stock-card-bottom">
          <span class="stock-card-date">Exp. ${date}</span>
          <span class="med-badge badge-${s}">${badge}</span>
          <div class="stock-card-actions">
            <button class="med-del" onclick="deleteMed('${m.id}')" title="Supprimer" style="width:32px;height:32px;border-radius:8px;border:1.5px solid var(--border);background:transparent;cursor:pointer;color:var(--muted);font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all 0.15s;">âœ•</button>
          </div>
        </div>
      </div>`;
  }).join('');
}

function setStockFilter(f, btn) {
  stockFilter = f;
  document.querySelectorAll('.stock-filters .filter-pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderStock();
}

function setLieuFilter(f, btn) {
  lieuFilter = f;
  document.querySelectorAll('#lieuTabs .lieu-tab').forEach(b => {
    b.className = 'lieu-tab';
  });
  btn.classList.add('active-' + (f === 'all' ? 'all' : f));
  renderStock();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER PAR MOIS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMonth() {
  updateStats();
  const y = currentMonth.getFullYear();
  const mo = currentMonth.getMonth();

  let list = meds.filter(m => {
    const exp = new Date(m.date + 'T00:00:00');
    if (exp.getFullYear() !== y || exp.getMonth() !== mo) return false;
    if (lieuFilterMonth !== 'all' && m.lieu !== lieuFilterMonth) return false;
    return true;
  }).sort((a, b) => new Date(a.date) - new Date(b.date));

  document.getElementById('badge-month').textContent = list.length || '0';

  let expC=0, soonC=0, okC=0;
  list.forEach(m => { const s=getStatus(m.date); if(s==='expired') expC++; else if(s==='soon') soonC++; else okC++; });

  const summaryEl = document.getElementById('monthSummary');
  summaryEl.innerHTML = list.length > 0 ? [
    expC  ? `<span class="summary-chip chip-expired">ğŸ”´ ${expC} pÃ©rimÃ©${expC>1?'s':''}</span>` : '',
    soonC ? `<span class="summary-chip chip-soon">ğŸŸ  ${soonC} bientÃ´t</span>` : '',
    okC   ? `<span class="summary-chip chip-ok">ğŸŸ¢ ${okC} OK</span>` : '',
  ].join('') : '';

  const btnExport = document.getElementById('btnExport');
  const container = document.getElementById('medList');

  if (list.length === 0) {
    btnExport.style.display = 'none';
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ“…</div>
        <p>Aucun mÃ©dicament ne pÃ©rime en ${currentMonth.toLocaleDateString('fr-FR', {month:'long', year:'numeric'})}${lieuFilterMonth !== 'all' ? ' pour ' + LIEU_LABELS[lieuFilterMonth] : ''}.</p>
      </div>`;
    return;
  }

  btnExport.style.display = 'flex';
  container.innerHTML = list.map(m => {
    const s     = getStatus(m.date);
    const badge = badgeLabel(s, m.date);
    const date  = new Date(m.date + 'T00:00:00').toLocaleDateString('fr-FR', { day:'2-digit', month:'long', year:'numeric' });
    return `
      <div class="med-item ${s}">
        <div class="med-name">ğŸ’Š ${esc(m.name)}</div>
        <span class="lieu-badge lieu-${m.lieu}">${LIEU_LABELS[m.lieu]}</span>
        <div class="med-date">Exp. ${date}</div>
        <span class="med-badge badge-${s}">${badge}</span>
      </div>`;
  }).join('');
}

function setLieuFilterMonth(f, btn) {
  lieuFilterMonth = f;
  document.querySelectorAll('#lieuTabsMonth .lieu-tab').forEach(b => b.className = 'lieu-tab');
  btn.classList.add('active-' + (f === 'all' ? 'all' : f));
  renderMonth();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NAVIGATION MOIS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateMonthDisplay() {
  const label = currentMonth.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
  document.getElementById('monthLabel').textContent = label;
  const y = currentMonth.getFullYear();
  const m = String(currentMonth.getMonth() + 1).padStart(2, '0');
  document.getElementById('monthPicker').value = `${y}-${m}`;
}

function changeMonth(d) {
  currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + d, 1);
  updateMonthDisplay(); renderMonth();
}

function goToToday() { currentMonth = new Date(); updateMonthDisplay(); renderMonth(); }

function onMonthPick() {
  const v = document.getElementById('monthPicker').value;
  if (!v) return;
  const [y, m] = v.split('-');
  currentMonth = new Date(parseInt(y), parseInt(m) - 1, 1);
  updateMonthDisplay(); renderMonth();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ADD / DELETE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkDuplicate(name, date, lieu) {
  // Recherche un mÃ©dicament avec nom similaire (insensible Ã  la casse) + mÃªme date + mÃªme lieu
  return meds.find(m =>
    m.lieu === lieu &&
    m.date === date &&
    m.name.toLowerCase().trim() === name.toLowerCase().trim()
  );
}

function addMed() {
  const name = document.getElementById('medName').value.trim();
  const date = document.getElementById('medDate').value;
  const lieu = document.getElementById('medLieu').value;
  if (!name || !date) { toast('Remplissez le nom et la date.', 'error'); return; }

  const duplicate = checkDuplicate(name, date, lieu);
  if (duplicate) {
    const dateStr = new Date(date + 'T00:00:00').toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
    if (!confirm(`"${duplicate.name}" avec la mÃªme pÃ©remption (${dateStr}) existe dÃ©jÃ  en ${LIEU_LABELS[lieu]}.\n\nS'agit-il du mÃªme mÃ©dicament ?`)) {
      // L'utilisateur dit non â†’ on ajoute quand mÃªme
    } else {
      // L'utilisateur dit oui â†’ on n'ajoute pas
      toast(`âš ï¸ Doublon ignorÃ© â€” ${name} dÃ©jÃ  prÃ©sent`, 'error');
      return;
    }
  }

  meds.push({ id: Date.now().toString(), name, date, lieu });
  save();
  document.getElementById('medName').value = '';
  document.getElementById('medDate').value = '';
  document.getElementById('transcript').textContent = 'Appuyez sur ğŸ¤ et dites par exemple : "Doliprane 1000 pÃ©remption mars 2026"';
  document.getElementById('transcript').classList.remove('active');
  toast(`âœ“ ${name} ajoutÃ© en ${LIEU_LABELS[lieu]}`);
  if (currentTab === 'stock') renderStock(); else renderMonth();
}

function deleteMed(id) {
  const med = meds.find(m => m.id === id);
  if (!med) return;
  if (!confirm(`Supprimer "${med.name}" ?`)) return;
  meds = meds.filter(m => m.id !== id);
  save();
  toast(`ğŸ—‘ ${med.name} supprimÃ©`);
  if (currentTab === 'stock') renderStock(); else renderMonth();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TRANSFERT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EXPORT PDF
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportPDF() {
  const label = currentMonth.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
  const lieu  = lieuFilterMonth !== 'all' ? ` â€” ${LIEU_LABELS[lieuFilterMonth]}` : '';
  document.getElementById('printSubtitle').textContent =
    `MÃ©dicaments pÃ©rimant en ${label}${lieu} â€” ImprimÃ© le ${new Date().toLocaleDateString('fr-FR')}`;
  setTimeout(() => window.print(), 100);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DICTÃ‰E VOCALE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let recognition = null, recording = false, chainMode = false;

// Mots-clÃ©s qui dÃ©clenchent l'enregistrement automatique
const SAVE_KEYWORDS = ['suivant', 'valider', 'enregistrer', 'ok', 'sauvegarder', 'ajouter'];

function setChainMode(active) {
  chainMode = active;
  const btn  = document.getElementById('chainBtn');
  const hint = document.getElementById('voiceHint');
  btn.classList.toggle('chain-active', active);
  if (active) {
    hint.innerHTML = 'ğŸ”— Mode chaÃ®ne actif â€” dites <strong>"Doliprane fÃ©vrier 2026 suivant"</strong> pour enregistrer et continuer automatiquement';
  } else {
    hint.innerHTML = 'ğŸ’¡ Dites : "Doliprane 500 pÃ©remption janvier 2027" â€” ou activez le <strong>mode chaÃ®ne</strong> pour enchaÃ®ner';
  }
}

function startListening() {
  if (!recognition) return;
  try {
    recognition.start();
    recording = true;
    document.getElementById('voiceBtn').textContent = 'â¹';
    document.getElementById('voiceBtn').classList.add('recording');
    document.getElementById('transcript').textContent = chainMode ? 'ğŸ”— En Ã©coute â€” dites le mÃ©dicament puis "suivant"â€¦' : 'En Ã©couteâ€¦';
    document.getElementById('transcript').classList.add('active');
  } catch(e) { toast('Impossible de dÃ©marrer le microphone.', 'error'); }
}

function stopListening() {
  if (recognition) recognition.stop();
}

function initVoice() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    document.getElementById('voiceBtn').disabled = true;
    document.getElementById('chainBtn').disabled = true;
    document.getElementById('voiceUnsupportedMsg').style.display = 'block';
    document.getElementById('voiceHint').style.display = 'none';
    document.getElementById('transcript').style.display = 'none';
    return;
  }
  try {
    recognition = new SR();
    recognition.lang = 'fr-FR';
    recognition.continuous = false;
    recognition.interimResults = true;

    recognition.onresult = (e) => {
      let interim = '', final = '';
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        if (e.results[i].isFinal) final += t; else interim += t;
      }
      const text = final || interim;
      document.getElementById('transcript').textContent = text;
      document.getElementById('transcript').classList.add('active');
      if (final) parseVoice(final);
    };

    recognition.onend = () => {
      recording = false;
      document.getElementById('voiceBtn').textContent = 'ğŸ¤';
      document.getElementById('voiceBtn').classList.remove('recording');
      // En mode chaÃ®ne, on redÃ©marre automatiquement si toujours actif
      if (chainMode) {
        setTimeout(() => { if (chainMode) startListening(); }, 400);
      }
    };

    recognition.onerror = (ev) => {
      recording = false;
      document.getElementById('voiceBtn').textContent = 'ğŸ¤';
      document.getElementById('voiceBtn').classList.remove('recording');
      if (ev.error === 'no-speech' && chainMode) {
        // En mode chaÃ®ne, on ignore "no-speech" et on relance
        setTimeout(() => { if (chainMode) startListening(); }, 600);
        return;
      }
      const msgs = { 'not-allowed': 'AccÃ¨s micro refusÃ©.', 'no-speech': 'Aucune parole dÃ©tectÃ©e.' };
      toast(msgs[ev.error] || 'Erreur microphone', 'error');
      if (chainMode) setChainMode(false);
    };

    // Bouton micro
    document.getElementById('voiceBtn').addEventListener('click', () => {
      if (recording) {
        if (chainMode) { setChainMode(false); stopListening(); }
        else { stopListening(); }
        return;
      }
      startListening();
    });

    // Bouton mode chaÃ®ne
    document.getElementById('chainBtn').addEventListener('click', () => {
      if (chainMode) {
        setChainMode(false);
        stopListening();
      } else {
        setChainMode(true);
        startListening();
      }
    });

  } catch(e) {
    document.getElementById('voiceBtn').disabled = true;
    document.getElementById('chainBtn').disabled = true;
    document.getElementById('voiceUnsupportedMsg').style.display = 'block';
  }
}

initVoice();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PARSING VOIX
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MONTHS_FR = {
  janvier:1, fÃ©vrier:2, fevrier:2, mars:3, avril:4, mai:5, juin:6,
  juillet:7, aoÃ»t:8, aout:8, septembre:9, octobre:10, novembre:11, dÃ©cembre:12, decembre:12
};

function parseVoice(text) {
  const t = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

  // â”€â”€ DÃ©tection mot-clÃ© de validation â”€â”€
  let autoSave = false;
  let cleanText = text;
  for (const kw of SAVE_KEYWORDS) {
    const re = new RegExp('\\s*' + kw + '\\s*$', 'i');
    if (re.test(t)) {
      autoSave = true;
      cleanText = text.replace(new RegExp('\\s*' + kw + '\\s*$', 'i'), '').trim();
      break;
    }
  }

  const tClean = cleanText.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

  let year = null, month = null, day = 1;
  let dateStartIndex = -1;

  const separators = ['date de peremption','peremption','expire le','expire en','expire','perime le','perime en','perime','jusqu au'];
  let sepIndex = -1;
  for (const sep of separators) {
    const idx = tClean.indexOf(sep);
    if (idx > 1) { sepIndex = idx; break; }
  }

  const reMonthYear = /(\d{1,2}\s+)?(janvier|fevrier|mars|avril|mai|juin|juillet|aout|septembre|octobre|novembre|decembre)\s+(\d{4})/;
  const reSlash = /(\d{1,2})[\/\-](\d{4})/;

  const searchZone = sepIndex >= 0 ? tClean.slice(sepIndex) : tClean;
  const searchZoneOffset = sepIndex >= 0 ? sepIndex : 0;

  const m1 = searchZone.match(reMonthYear);
  if (m1) {
    month = MONTHS_FR[m1[2]]; year = parseInt(m1[3]);
    day   = m1[1] ? parseInt(m1[1]) : new Date(year, month, 0).getDate();
    dateStartIndex = searchZoneOffset + searchZone.indexOf(m1[0]);
  }

  if (!month) {
    const m2 = searchZone.match(reSlash);
    if (m2) {
      month = parseInt(m2[1]); year = parseInt(m2[2]);
      day   = new Date(year, month, 0).getDate();
      dateStartIndex = searchZoneOffset + searchZone.indexOf(m2[0]);
    }
  }

  let cutAt = sepIndex >= 0 ? sepIndex : (dateStartIndex >= 0 ? dateStartIndex : -1);
  let name = cutAt > 0 ? cleanText.slice(0, cutAt) : cleanText;
  name = name.replace(/\s+(le|la|les|du|de|en|au|pour|avec|et)\s*$/i, '').replace(/[,;:\-]+$/, '').replace(/\s+/g, ' ').trim();
  if (name) name = name.charAt(0).toUpperCase() + name.slice(1);
  if (name) document.getElementById('medName').value = name;

  if (year && month) {
    document.getElementById('medDate').value = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    if (!autoSave) toast(`ğŸ¤ "${name}" â€” ${String(month).padStart(2,'0')}/${year}`);
  } else if (name && !autoSave) {
    toast(`ğŸ¤ Nom : "${name}" â€” VÃ©rifiez la date`);
  }

  // â”€â”€ Auto-save si mot-clÃ© dÃ©tectÃ© â”€â”€
  if (autoSave && name && year && month) {
    // Petit dÃ©lai pour que l'UI se mette Ã  jour avant l'enregistrement
    setTimeout(() => {
      addMedSilent(name, `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`);
    }, 200);
  }
}

function addMedSilent(name, date) {
  const lieu = document.getElementById('medLieu').value;

  const duplicate = checkDuplicate(name, date, lieu);
  if (duplicate) {
    const dateStr = new Date(date + 'T00:00:00').toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
    if (confirm(`"${duplicate.name}" (${dateStr}) existe dÃ©jÃ  en ${LIEU_LABELS[lieu]}.\n\nS'agit-il du mÃªme mÃ©dicament ?`)) {
      document.getElementById('transcript').textContent = `âš ï¸ Doublon ignorÃ© â€” en Ã©coute pour le suivantâ€¦`;
      document.getElementById('medName').value = '';
      document.getElementById('medDate').value = '';
      toast(`âš ï¸ Doublon ignorÃ© â€” ${name}`, 'error');
      return;
    }
  }

  meds.push({ id: Date.now().toString(), name, date, lieu });
  save();
  document.getElementById('transcript').textContent = `âœ“ "${name}" enregistrÃ© â€” en Ã©coute pour le suivantâ€¦`;
  document.getElementById('medName').value = '';
  document.getElementById('medDate').value = '';
  toast(`âœ“ ${name} ajoutÃ© !`);
  if (currentTab === 'stock') renderStock(); else renderMonth();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DÃ‰TECTION DOUBLONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function detectDuplicates() {
  // Groupe par lieu + nom (insensible casse) + date
  const groups = {};
  meds.forEach(m => {
    const key = `${m.lieu}||${m.name.toLowerCase().trim()}||${m.date}`;
    if (!groups[key]) groups[key] = [];
    groups[key].push(m);
  });

  const dupes = Object.values(groups).filter(g => g.length > 1);

  const overlay = document.getElementById('dupesOverlay');
  const info    = document.getElementById('dupesInfo');
  const list    = document.getElementById('dupesList');

  if (dupes.length === 0) {
    toast('âœ… Aucun doublon trouvÃ© dans ton stock !');
    return;
  }

  info.textContent = `${dupes.length} groupe${dupes.length > 1 ? 's' : ''} de doublons trouvÃ©${dupes.length > 1 ? 's' : ''} dans le mÃªme lieu.`;

  list.innerHTML = dupes.map(group => {
    const date = new Date(group[0].date + 'T00:00:00').toLocaleDateString('fr-FR', { day:'2-digit', month:'long', year:'numeric' });
    const items = group.map(m => `
      <div class="dupe-item">
        <span>${m.name}</span>
        <span class="dupe-lieu">${LIEU_LABELS[m.lieu]}</span>
        <span class="dupe-date">Exp. ${date}</span>
        <button class="med-del" onclick="deleteMedFromDupes('${m.id}')"
          style="width:26px;height:26px;border-radius:6px;border:1.5px solid var(--border);background:transparent;cursor:pointer;color:var(--muted);font-size:0.85rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;">âœ•</button>
      </div>`).join('');
    return `
      <div class="dupe-group">
        <div class="dupe-group-title">âš ï¸ ${group[0].name} â€” ${group.length} entrÃ©es</div>
        ${items}
      </div>`;
  }).join('');

  overlay.classList.add('open');
}

function deleteMedFromDupes(id) {
  const med = meds.find(m => m.id === id);
  if (!med) return;
  if (!confirm(`Supprimer "${med.name}" ?`)) return;
  meds = meds.filter(m => m.id !== id);
  save();
  toast(`ğŸ—‘ ${med.name} supprimÃ©`);
  // RafraÃ®chit la liste des doublons
  detectDuplicates();
  // Si plus de doublons, ferme le modal
  const groups = {};
  meds.forEach(m => {
    const key = `${m.lieu}||${m.name.toLowerCase().trim()}||${m.date}`;
    if (!groups[key]) groups[key] = [];
    groups[key].push(m);
  });
  if (!Object.values(groups).some(g => g.length > 1)) closeDupesModal();
  if (currentTab === 'stock') renderStock(); else renderMonth();
}

function closeDupesModal() {
  document.getElementById('dupesOverlay').classList.remove('open');
}


function exportJSON() {
  const data = JSON.stringify(meds, null, 2);
  const b64  = btoa(unescape(encodeURIComponent(data)));
  const a    = document.createElement('a');
  a.href     = 'data:application/json;charset=utf-8;base64,' + b64;
  a.download = `pharmacie-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  toast(`âœ“ Sauvegarde exportÃ©e (${meds.length} mÃ©dicament${meds.length > 1 ? 's' : ''})`);
}

function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const imported = JSON.parse(e.target.result);
      if (!Array.isArray(imported)) throw new Error('Format invalide');
      // Fusionne sans doublons (basÃ© sur l'id)
      const existingIds = new Set(meds.map(m => m.id));
      const newMeds = imported.filter(m => !existingIds.has(m.id));
      meds = [...meds, ...newMeds];
      save();
      renderStock();
      toast(`âœ“ ${newMeds.length} mÃ©dicament${newMeds.length > 1 ? 's' : ''} importÃ©${newMeds.length > 1 ? 's' : ''} (${imported.length - newMeds.length} dÃ©jÃ  prÃ©sent${imported.length - newMeds.length > 1 ? 's' : ''})`);
    } catch(err) {
      toast('âš ï¸ Fichier invalide â€” utilisez un export PharmExpiry', 'error');
    }
    // Reset l'input pour permettre de rÃ©importer le mÃªme fichier
    event.target.value = '';
  };
  reader.readAsText(file);
}





if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/P-remptions-/service-worker.js')
      .catch(err => console.log('SW non enregistrÃ© :', err));
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateMonthDisplay();
renderStock();
</script>
</body>
</html>
