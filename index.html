<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PharmExpiry â€” Gestion des pÃ©remptions</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2d6a4f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PharmExpiry">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f0ede8;
    --surface: #faf9f7;
    --border: #d8d3ca;
    --text: #1a1916;
    --muted: #7a756c;
    --accent: #2d6a4f;
    --accent-light: #d8ead2;
    --warn: #b5541a;
    --warn-light: #fdebd8;
    --danger: #8b1a1a;
    --danger-light: #fde8e8;
    --ok: #2d6a4f;
    --ok-light: #d8ead2;
    --ink: #1a1916;
    --radius: 12px;
    --vss: #1a4a7a;
    --vss-light: #ddeaf7;
    --sds: #6b3a8f;
    --sds-light: #ecdff7;
    --reserve: #2d6a4f;
    --reserve-light: #d8ead2;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 24px;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 1.5px solid var(--border);
  }

  .logo h1 { font-family: 'DM Serif Display', serif; font-size: 2.2rem; letter-spacing: -0.5px; }
  .logo span { color: var(--accent); }
  .logo p { font-size: 0.8rem; color: var(--muted); font-family: 'DM Mono', monospace; letter-spacing: 0.05em; text-transform: uppercase; margin-top: 2px; }

  .stats-bar { display: flex; gap: 20px; align-items: flex-end; flex-direction: column; }

  .stats-row { display: flex; gap: 20px; }

  .stat { text-align: right; }
  .stat .n { font-family: 'DM Serif Display', serif; font-size: 1.8rem; line-height: 1; }
  .stat .l { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; font-family: 'DM Mono', monospace; }
  .stat.warn .n { color: var(--warn); }
  .stat.danger .n { color: var(--danger); }

  /* â”€â”€ LIEUX BADGES â”€â”€ */
  .lieu-badge {
    display: inline-flex;
    align-items: center;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 0.72rem;
    font-family: 'DM Mono', monospace;
    font-weight: 600;
    letter-spacing: 0.04em;
    white-space: nowrap;
  }

  .lieu-VSS      { background: var(--vss-light); color: var(--vss); }
  .lieu-SDS      { background: var(--sds-light); color: var(--sds); }
  .lieu-Reserve  { background: var(--reserve-light); color: var(--reserve); }

  /* â”€â”€ ENCART AJOUT â”€â”€ */
  .add-card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 28px;
  }

  .add-card h2 { font-family: 'DM Serif Display', serif; font-size: 1.15rem; margin-bottom: 16px; }

  .voice-unsupported-msg {
    font-size: 0.82rem; color: var(--warn);
    font-family: 'DM Mono', monospace;
    background: var(--warn-light); border: 1px solid var(--warn);
    border-radius: 8px; padding: 8px 12px; margin-bottom: 12px;
  }

  .voice-btn {
    width: 64px; height: 64px; border-radius: 50%; border: none;
    background: var(--accent); color: white; font-size: 1.5rem;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(45,106,79,0.3);
  }
  .voice-btn:hover { transform: scale(1.05); }
  .voice-btn.recording { background: var(--danger); animation: pulse 1s infinite; }
  .voice-btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }

  @keyframes pulse {
    0%,100% { box-shadow: 0 4px 20px rgba(139,26,26,0.4); }
    50% { box-shadow: 0 4px 32px rgba(139,26,26,0.7); }
  }

  .voice-area { display: flex; gap: 16px; align-items: flex-start; }
  .voice-fields { flex: 1; display: flex; flex-direction: column; gap: 10px; }

  .transcript-box {
    background: var(--bg); border: 1.5px solid var(--border);
    border-radius: 8px; padding: 12px;
    font-family: 'DM Mono', monospace; font-size: 0.85rem;
    color: var(--muted); min-height: 48px; transition: border-color 0.2s;
  }
  .transcript-box.active { border-color: var(--accent); color: var(--text); }

  .fields-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 10px; align-items: end;
  }

  label {
    display: block; font-size: 0.72rem; text-transform: uppercase;
    letter-spacing: 0.08em; font-family: 'DM Mono', monospace;
    color: var(--muted); margin-bottom: 5px;
  }

  input[type="text"], input[type="month"], input[type="date"], select {
    width: 100%; padding: 10px 12px;
    background: var(--bg); border: 1.5px solid var(--border);
    border-radius: 8px; font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem; color: var(--text); outline: none;
    transition: border-color 0.2s; -webkit-appearance: none; appearance: none;
  }

  select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%237a756c'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 10px center;
    padding-right: 28px;
  }

  input:focus, select:focus { border-color: var(--accent); }

  .btn {
    padding: 10px 20px; border: none; border-radius: 8px;
    font-family: 'DM Sans', sans-serif; font-size: 0.9rem;
    font-weight: 600; cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }

  .voice-hint { font-size: 0.78rem; color: var(--muted); font-style: italic; }

  /* â”€â”€ ONGLETS PRINCIPAUX â”€â”€ */
  .tabs {
    display: flex; gap: 0; margin-bottom: 24px;
    border-bottom: 2px solid var(--border);
  }

  .tab {
    padding: 10px 24px; border: none; background: transparent;
    font-family: 'DM Sans', sans-serif; font-size: 0.9rem;
    font-weight: 500; color: var(--muted); cursor: pointer;
    transition: all 0.2s; border-bottom: 2.5px solid transparent;
    margin-bottom: -2px; display: flex; align-items: center; gap: 7px;
  }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }
  .tab:not(.active):hover { color: var(--text); }

  .tab-badge {
    font-size: 0.68rem; font-family: 'DM Mono', monospace;
    background: var(--border); color: var(--muted);
    padding: 1px 7px; border-radius: 20px;
  }
  .tab.active .tab-badge { background: var(--accent-light); color: var(--accent); }

  /* â”€â”€ SECTIONS â”€â”€ */
  .section { display: none; }
  .section.active { display: block; }

  /* â”€â”€ ONGLETS LIEUX (sous-navigation) â”€â”€ */
  .lieu-tabs {
    display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;
  }

  .lieu-tab {
    padding: 8px 20px; border-radius: 8px;
    border: 1.5px solid var(--border);
    background: var(--surface);
    font-family: 'DM Sans', sans-serif; font-size: 0.85rem;
    font-weight: 500; color: var(--muted); cursor: pointer;
    transition: all 0.2s; display: flex; align-items: center; gap: 8px;
  }
  .lieu-tab:hover { border-color: var(--text); color: var(--text); }
  .lieu-tab.active-VSS     { background: var(--vss); border-color: var(--vss); color: white; }
  .lieu-tab.active-SDS     { background: var(--sds); border-color: var(--sds); color: white; }
  .lieu-tab.active-Reserve { background: var(--reserve); border-color: var(--reserve); color: white; }
  .lieu-tab.active-all     { background: var(--ink); border-color: var(--ink); color: white; }

  .lieu-tab .count {
    font-size: 0.7rem; font-family: 'DM Mono', monospace;
    background: rgba(255,255,255,0.25); padding: 1px 6px; border-radius: 10px;
  }
  .lieu-tab:not([class*="active"]) .count {
    background: var(--bg); color: var(--muted);
  }

  /* â”€â”€ STOCK TABLE â”€â”€ */
  .stock-controls {
    display: flex; gap: 10px; margin-bottom: 16px;
    align-items: center; flex-wrap: wrap;
  }

  .search-input { flex: 1; min-width: 180px; }

  .sort-select {
    padding: 10px 32px 10px 12px; border: 1.5px solid var(--border);
    border-radius: 8px; font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem; background: var(--surface); color: var(--muted);
    outline: none; cursor: pointer; -webkit-appearance: none; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%237a756c'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 10px center;
    width: auto;
  }

  .stock-filters { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }

  .filter-pill {
    padding: 5px 14px; border-radius: 20px; border: 1.5px solid var(--border);
    background: transparent; font-size: 0.78rem; cursor: pointer;
    font-family: 'DM Sans', sans-serif; transition: all 0.15s; color: var(--muted);
  }
  .filter-pill.active      { background: var(--ink); border-color: var(--ink); color: white; }
  .filter-pill.f-expired.active { background: var(--danger); border-color: var(--danger); }
  .filter-pill.f-soon.active    { background: var(--warn); border-color: var(--warn); }
  .filter-pill.f-ok.active      { background: var(--ok); border-color: var(--ok); }

  /* RÃ©sumÃ© global */
  .global-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .summary-card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
  }

  .summary-card-title {
    font-size: 0.7rem; font-family: 'DM Mono', monospace;
    text-transform: uppercase; letter-spacing: 0.06em;
    margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
  }

  .summary-card-title .dot {
    width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  }
  .dot-VSS     { background: var(--vss); }
  .dot-SDS     { background: var(--sds); }
  .dot-Reserve { background: var(--reserve); }

  .summary-card-stats {
    display: flex; gap: 10px; flex-wrap: wrap;
  }

  .mini-stat { text-align: center; }
  .mini-stat .n { font-family: 'DM Serif Display', serif; font-size: 1.3rem; line-height: 1; }
  .mini-stat .l { font-size: 0.62rem; font-family: 'DM Mono', monospace; color: var(--muted); text-transform: uppercase; }
  .mini-stat.danger .n { color: var(--danger); }
  .mini-stat.warn .n { color: var(--warn); }

  .stock-table-wrap {
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: var(--radius); overflow: hidden;
  }

  .stock-table-header {
    padding: 14px 20px; border-bottom: 1.5px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    background: var(--bg);
  }
  .stock-table-header span { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }

  table { width: 100%; border-collapse: collapse; }
  thead th {
    text-align: left; padding: 10px 20px;
    font-size: 0.68rem; font-family: 'DM Mono', monospace;
    text-transform: uppercase; letter-spacing: 0.08em;
    color: var(--muted); border-bottom: 1px solid var(--border); background: var(--bg);
  }
  tbody td { padding: 12px 20px; font-size: 0.88rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tbody tr:last-child td { border-bottom: none; }
  tbody tr:hover td { background: #f5f3ef; }
  .td-name { font-weight: 600; }
  .td-date { font-family: 'DM Mono', monospace; font-size: 0.82rem; color: var(--muted); white-space: nowrap; }
  .td-actions { width: 80px; text-align: right; display: flex; gap: 6px; justify-content: flex-end; }

  /* â”€â”€ BOUTONS ACTION TABLE â”€â”€ */
  .btn-transfer {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 4px 10px; border-radius: 6px;
    border: 1.5px solid var(--accent); background: var(--accent-light);
    cursor: pointer; color: var(--accent); font-size: 0.75rem;
    font-family: 'DM Sans', sans-serif; font-weight: 600;
    transition: all 0.15s; white-space: nowrap;
  }
  .btn-transfer:hover { background: var(--accent); color: white; }

  .med-del {
    width: 28px; height: 28px; border-radius: 6px;
    border: 1.5px solid transparent; background: transparent;
    cursor: pointer; color: var(--muted); font-size: 0.85rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; flex-shrink: 0;
  }
  .med-del:hover { border-color: var(--danger); color: var(--danger); background: var(--danger-light); }

  /* â”€â”€ MODAL TRANSFERT â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(26,25,22,0.5);
    display: flex; align-items: center; justify-content: center;
    z-index: 500; padding: 20px;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface); border-radius: var(--radius);
    padding: 28px; width: 100%; max-width: 400px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    transform: translateY(16px); transition: transform 0.2s;
  }
  .modal-overlay.open .modal { transform: translateY(0); }

  .modal h3 { font-family: 'DM Serif Display', serif; font-size: 1.2rem; margin-bottom: 6px; }
  .modal .med-info { font-size: 0.82rem; color: var(--muted); font-family: 'DM Mono', monospace; margin-bottom: 20px; }

  .modal-fields { display: flex; flex-direction: column; gap: 14px; margin-bottom: 20px; }

  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

  .btn-cancel {
    padding: 9px 18px; border: 1.5px solid var(--border);
    border-radius: 8px; background: transparent;
    font-family: 'DM Sans', sans-serif; font-size: 0.88rem;
    color: var(--muted); cursor: pointer; transition: all 0.15s;
  }
  .btn-cancel:hover { border-color: var(--text); color: var(--text); }

  .qty-input {
    width: 100%; padding: 10px 12px;
    background: var(--bg); border: 1.5px solid var(--border);
    border-radius: 8px; font-family: 'DM Sans', sans-serif;
    font-size: 1rem; color: var(--text); outline: none;
    transition: border-color 0.2s; text-align: center;
    font-weight: 600;
  }
  .qty-input:focus { border-color: var(--accent); }

  .transfer-choice {
    display: flex; gap: 10px;
  }

  .transfer-opt {
    flex: 1; padding: 12px; border-radius: 10px;
    border: 2px solid var(--border); background: var(--bg);
    cursor: pointer; text-align: left; transition: all 0.15s;
    display: flex; flex-direction: column; gap: 3px;
  }
  .transfer-opt:hover { border-color: var(--accent); }
  .transfer-opt.active { border-color: var(--accent); background: var(--accent-light); }

  .opt-icon { font-size: 1.2rem; }
  .opt-label { font-family: 'DM Sans', sans-serif; font-weight: 700; font-size: 0.9rem; color: var(--text); }
  .opt-desc  { font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--muted); line-height: 1.3; }
  .transfer-opt.active .opt-desc { color: var(--accent); }

  .qty-row { display: flex; gap: 8px; align-items: center; }
  .qty-btn {
    width: 40px; height: 40px; border-radius: 8px;
    border: 1.5px solid var(--border); background: var(--bg);
    font-size: 1.2rem; cursor: pointer; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .qty-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ VUE PAR MOIS â”€â”€ */
  .month-picker-bar {
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: var(--radius); padding: 18px 20px;
    margin-bottom: 20px; display: flex;
    align-items: center; gap: 14px; flex-wrap: wrap;
  }

  .month-nav-group { display: flex; align-items: center; gap: 8px; flex: 1; }

  .nav-btn {
    width: 34px; height: 34px; border-radius: 50%;
    border: 1.5px solid var(--border); background: var(--bg);
    cursor: pointer; font-size: 1rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; color: var(--text); flex-shrink: 0;
  }
  .nav-btn:hover { border-color: var(--accent); color: var(--accent); }

  .month-label-display {
    font-family: 'DM Serif Display', serif; font-size: 1.3rem;
    text-transform: capitalize; flex: 1; text-align: center;
  }

  .btn-today {
    padding: 6px 14px; border-radius: 20px;
    border: 1.5px solid var(--border); background: var(--bg);
    font-size: 0.75rem; font-family: 'DM Mono', monospace;
    cursor: pointer; transition: all 0.15s; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.06em; white-space: nowrap;
  }
  .btn-today:hover { border-color: var(--accent); color: var(--accent); }

  .month-actions {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 16px; flex-wrap: wrap; gap: 10px;
  }

  .month-summary { display: flex; gap: 8px; flex-wrap: wrap; }

  .summary-chip {
    padding: 5px 12px; border-radius: 20px;
    font-size: 0.78rem; font-family: 'DM Mono', monospace;
    display: flex; align-items: center; gap: 5px;
  }
  .chip-expired { background: var(--danger-light); color: var(--danger); }
  .chip-soon    { background: var(--warn-light); color: var(--warn); }
  .chip-ok      { background: var(--ok-light); color: var(--ok); }

  .btn-export {
    display: flex; align-items: center; gap: 8px; padding: 9px 18px;
    border: 1.5px solid var(--accent); border-radius: 8px;
    background: var(--accent-light); color: var(--accent);
    font-family: 'DM Sans', sans-serif; font-size: 0.85rem;
    font-weight: 600; cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .btn-export:hover { background: var(--accent); color: white; }

  /* â”€â”€ LISTE MEDS (vue mois) â”€â”€ */
  .med-list { display: flex; flex-direction: column; gap: 8px; }

  .med-item {
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: var(--radius); padding: 14px 18px;
    display: flex; align-items: center; gap: 12px;
    transition: all 0.15s; animation: slideIn 0.25s ease;
  }
  @keyframes slideIn { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }

  .med-item:hover { border-color: var(--accent); }
  .med-item.expired { border-color: var(--danger); background: var(--danger-light); }
  .med-item.soon    { border-color: var(--warn); background: var(--warn-light); }
  .med-item.ok      { border-left: 3px solid var(--ok); }

  .med-name { font-weight: 600; font-size: 0.95rem; flex: 1; }
  .med-date { font-family: 'DM Mono', monospace; font-size: 0.82rem; color: var(--muted); white-space: nowrap; }

  .med-badge {
    font-family: 'DM Mono', monospace; font-size: 0.72rem;
    padding: 3px 10px; border-radius: 20px; font-weight: 500; white-space: nowrap;
  }
  .badge-ok      { background: var(--ok-light); color: var(--ok); }
  .badge-soon    { background: var(--warn-light); color: var(--warn); }
  .badge-expired { background: var(--danger-light); color: var(--danger); }

  .med-del-round {
    width: 30px; height: 30px; border-radius: 50%;
    border: 1.5px solid transparent; background: transparent;
    cursor: pointer; color: var(--muted); font-size: 1rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; flex-shrink: 0;
  }
  .med-del-round:hover { border-color: var(--danger); color: var(--danger); background: var(--danger-light); }

  .empty-state {
    text-align: center; padding: 60px 20px; color: var(--muted);
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: var(--radius);
  }
  .empty-state .icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.4; }
  .empty-state p { font-size: 0.88rem; }

  /* â”€â”€ TOAST â”€â”€ */
  .toast {
    position: fixed; bottom: 24px; right: 24px;
    background: var(--ink); color: white; padding: 12px 20px;
    border-radius: 10px; font-size: 0.85rem;
    font-family: 'DM Mono', monospace;
    transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 1000;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { background: var(--accent); }
  .toast.error   { background: var(--danger); }

  /* â”€â”€ PRINT â”€â”€ */
  .print-header { display: none; }
  .print-stats  { display: none; }

  @media print {
    body { background: white; padding: 0; }
    header, .add-card, .tabs, #section-stock, .month-picker-bar,
    .month-actions, .lieu-tabs, .toast, .med-del-round, .modal-overlay { display: none !important; }
    #section-month { display: block !important; }
    .print-header { display: block !important; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 2px solid #1a1916; }
    .print-title { font-family: 'DM Serif Display', serif; font-size: 1.6rem; }
    .print-subtitle { font-size: 0.8rem; color: #7a756c; font-family: monospace; text-transform: uppercase; letter-spacing: 0.06em; margin-top: 4px; }
    .month-summary { margin-bottom: 16px; }
    .summary-chip { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .lieu-badge   { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .med-item { break-inside: avoid; border: 1px solid #d8d3ca !important; margin-bottom: 6px; padding: 10px 14px; }
    .med-item.expired { background: #fde8e8 !important; border-color: #8b1a1a !important; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .med-item.soon    { background: #fdebd8 !important; border-color: #b5541a !important; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .med-badge { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .empty-state { border: 1px solid #d8d3ca; }
    @page { margin: 20mm 15mm; }
  }

  /* â”€â”€ RESPONSIVE â”€â”€ */
  @media (max-width: 640px) {
    .stats-bar { display: none; }
    .fields-row { grid-template-columns: 1fr 1fr; }
    .fields-row > *:nth-child(3) { grid-column: 1 / -1; }
    .fields-row .btn { grid-column: 1 / -1; }
    body { padding: 16px; }
    .global-summary { grid-template-columns: 1fr; }
    thead th:nth-child(3), tbody td:nth-child(3) { display: none; }
    .month-picker-bar { flex-direction: column; align-items: stretch; }
    .month-nav-group { justify-content: center; }
  }
</style>
</head>
<body>

<!-- â•â• HEADER â•â• -->
<header>
  <div class="logo">
    <h1>Pharm<span>Expiry</span></h1>
    <p>Gestion des dates de pÃ©remption</p>
  </div>
  <div class="stats-bar">
    <div class="stats-row">
      <div class="stat danger" id="stat-expired"><div class="n">0</div><div class="l">PÃ©rimÃ©s</div></div>
      <div class="stat warn"   id="stat-soon">   <div class="n">0</div><div class="l">BientÃ´t</div></div>
      <div class="stat"        id="stat-total">  <div class="n">0</div><div class="l">Total</div></div>
    </div>
  </div>
</header>

<!-- â•â• ENCART AJOUT â•â• -->
<div class="add-card">
  <h2>ğŸ¤ Ajouter un mÃ©dicament</h2>
  <div id="voiceUnsupportedMsg" class="voice-unsupported-msg" style="display:none;">
    ğŸ¤ La dictÃ©e vocale n'est pas disponible sur ce navigateur.
  </div>
  <div class="voice-area">
    <button class="voice-btn" id="voiceBtn" title="DictÃ©e vocale">ğŸ¤</button>
    <div class="voice-fields">
      <div class="transcript-box" id="transcript">Appuyez sur ğŸ¤ et dites par exemple : "Doliprane 1000 pÃ©remption mars 2026"</div>
      <div class="fields-row">
        <div>
          <label>MÃ©dicament</label>
          <input type="text" id="medName" placeholder="Nom du mÃ©dicament">
        </div>
        <div>
          <label>Date de pÃ©remption</label>
          <input type="date" id="medDate">
        </div>
        <div>
          <label>Lieu</label>
          <select id="medLieu">
            <option value="Reserve">RÃ©serve</option>
            <option value="VSS">VSS</option>
            <option value="SDS">SDS</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="addMed()">+ Ajouter</button>
      </div>
      <p class="voice-hint" id="voiceHint">ğŸ’¡ Dites : "Doliprane 500 pÃ©remption janvier 2027"</p>
    </div>
  </div>
</div>

<!-- â•â• ONGLETS PRINCIPAUX â•â• -->
<div class="tabs">
  <button class="tab active" id="tab-stock" onclick="switchTab('stock')">
    ğŸ“¦ Stock total <span class="tab-badge" id="badge-stock">0</span>
  </button>
  <button class="tab" id="tab-month" onclick="switchTab('month')">
    ğŸ“… Par mois <span class="tab-badge" id="badge-month">â€”</span>
  </button>
</div>

<!-- â•â•â•â•â•â• ONGLET STOCK TOTAL â•â•â•â•â•â• -->
<div class="section active" id="section-stock">

  <!-- RÃ©sumÃ© global par lieu -->
  <div class="global-summary" id="globalSummary"></div>

  <!-- ContrÃ´les -->
  <div class="stock-controls">
    <input class="search-input" type="text" id="searchStock" placeholder="ğŸ” Rechercher dans le stockâ€¦" oninput="renderStock()">
    <select class="sort-select" id="sortStock" onchange="renderStock()">
      <option value="status">Urgence d'abord</option>
      <option value="date-asc">Date la plus proche</option>
      <option value="date-desc">Date la plus lointaine</option>
      <option value="name-asc">Nom A â†’ Z</option>
      <option value="name-desc">Nom Z â†’ A</option>
      <option value="lieu">Par lieu</option>
    </select>
  </div>

  <!-- Filtres statut -->
  <div class="stock-filters">
    <button class="filter-pill active"    onclick="setStockFilter('all', this)">Tout</button>
    <button class="filter-pill f-expired" onclick="setStockFilter('expired', this)">ğŸ”´ PÃ©rimÃ©s</button>
    <button class="filter-pill f-soon"    onclick="setStockFilter('soon', this)">ğŸŸ  BientÃ´t (â‰¤30j)</button>
    <button class="filter-pill f-ok"      onclick="setStockFilter('ok', this)">ğŸŸ¢ OK</button>
  </div>

  <!-- Filtre lieu -->
  <div class="lieu-tabs" id="lieuTabs">
    <button class="lieu-tab active-all" onclick="setLieuFilter('all', this)">
      Tous les lieux <span class="count" id="count-all">0</span>
    </button>
    <button class="lieu-tab" onclick="setLieuFilter('VSS', this)">
      VSS <span class="count" id="count-VSS">0</span>
    </button>
    <button class="lieu-tab" onclick="setLieuFilter('SDS', this)">
      SDS <span class="count" id="count-SDS">0</span>
    </button>
    <button class="lieu-tab" onclick="setLieuFilter('Reserve', this)">
      RÃ©serve <span class="count" id="count-Reserve">0</span>
    </button>
  </div>

  <!-- Tableau -->
  <div class="stock-table-wrap">
    <div class="stock-table-header">
      <span id="stockCountLabel">0 mÃ©dicament</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>MÃ©dicament</th>
          <th>Lieu</th>
          <th>Date pÃ©remption</th>
          <th>Statut</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="stockBody"></tbody>
    </table>
    <div id="stockEmpty" class="empty-state" style="display:none;">
      <div class="icon">ğŸ“¦</div><p>Aucun mÃ©dicament dans le stock.</p>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• ONGLET PAR MOIS â•â•â•â•â•â• -->
<div class="section" id="section-month">

  <div class="print-header">
    <div class="print-title">Pharm<span style="color:#2d6a4f">Expiry</span> â€” PÃ©remptions du mois</div>
    <div class="print-subtitle" id="printSubtitle"></div>
  </div>

  <div class="month-picker-bar">
    <label>Mois Ã  afficher</label>
    <div class="month-nav-group">
      <button class="nav-btn" onclick="changeMonth(-1)">â€¹</button>
      <div class="month-label-display" id="monthLabel"></div>
      <button class="nav-btn" onclick="changeMonth(1)">â€º</button>
    </div>
    <input style="padding:8px 12px;width:auto;font-size:0.85rem;" type="month" id="monthPicker" onchange="onMonthPick()">
    <button class="btn-today" onclick="goToToday()">Ce mois-ci</button>
  </div>

  <!-- Filtre lieu dans vue mois aussi -->
  <div class="lieu-tabs" id="lieuTabsMonth">
    <button class="lieu-tab active-all" onclick="setLieuFilterMonth('all', this)">Tous les lieux</button>
    <button class="lieu-tab" onclick="setLieuFilterMonth('VSS', this)">VSS</button>
    <button class="lieu-tab" onclick="setLieuFilterMonth('SDS', this)">SDS</button>
    <button class="lieu-tab" onclick="setLieuFilterMonth('Reserve', this)">RÃ©serve</button>
  </div>

  <div class="month-actions">
    <div class="month-summary" id="monthSummary"></div>
    <button class="btn-export" onclick="exportPDF()" id="btnExport" style="display:none;">â¬‡ Exporter en PDF</button>
  </div>

  <div class="med-list" id="medList"></div>
</div>

<!-- â•â• MODAL TRANSFERT â•â• -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal">
    <h3>â†— TransfÃ©rer depuis la RÃ©serve</h3>
    <div class="med-info" id="modalMedInfo"></div>
    <div class="modal-fields">
      <div>
        <label>Vers le lieu</label>
        <select id="transferDest">
          <option value="VSS">VSS</option>
          <option value="SDS">SDS</option>
        </select>
      </div>
      <div>
        <label>Type de transfert</label>
        <div class="transfer-choice">
          <button class="transfer-opt active" id="opt-tout" onclick="selectTransferType('tout')">
            <span class="opt-icon">ğŸ“¦â†’</span>
            <span class="opt-label">Tout</span>
            <span class="opt-desc">DÃ©place et supprime de la RÃ©serve</span>
          </button>
          <button class="transfer-opt" id="opt-partiel" onclick="selectTransferType('partiel')">
            <span class="opt-icon">ğŸ“‹</span>
            <span class="opt-label">Partiel</span>
            <span class="opt-desc">Copie, reste aussi en RÃ©serve</span>
          </button>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModalDirect()">Annuler</button>
      <button class="btn btn-primary" onclick="confirmTransfer()">TransfÃ©rer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STORAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let meds = [];

function loadData() {
  try {
    const raw = localStorage.getItem('pharmExpiry_v2');
    if (raw) meds = JSON.parse(raw);
    // Migration depuis l'ancienne version sans lieu
    meds = meds.map(m => ({ lieu: 'Reserve', qty: 1, ...m }));
  } catch(e) { meds = []; }
}

function save() {
  try { localStorage.setItem('pharmExpiry_v2', JSON.stringify(meds)); }
  catch(e) { toast('âš ï¸ Stockage non disponible', 'error'); }
}

loadData();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentTab        = 'stock';
let stockFilter       = 'all';
let lieuFilter        = 'all';
let lieuFilterMonth   = 'all';
let currentMonth      = new Date();
let transferMedId     = null;

const LIEUX = ['VSS', 'SDS', 'Reserve'];
const LIEU_LABELS = { VSS: 'VSS', SDS: 'SDS', Reserve: 'RÃ©serve' };

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TABS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  currentTab = tab;
  document.getElementById('section-stock').classList.toggle('active', tab === 'stock');
  document.getElementById('section-month').classList.toggle('active', tab === 'month');
  document.getElementById('tab-stock').classList.toggle('active', tab === 'stock');
  document.getElementById('tab-month').classList.toggle('active', tab === 'month');
  if (tab === 'stock') renderStock();
  else renderMonth();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TOAST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast ' + type; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATUS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getStatus(dateStr) {
  const today = new Date(); today.setHours(0,0,0,0);
  const diff = Math.floor((new Date(dateStr + 'T00:00:00') - today) / 86400000);
  return diff < 0 ? 'expired' : diff <= 30 ? 'soon' : 'ok';
}

function getDiff(dateStr) {
  const today = new Date(); today.setHours(0,0,0,0);
  return Math.floor((new Date(dateStr + 'T00:00:00') - today) / 86400000);
}

function badgeLabel(status, dateStr) {
  const diff = getDiff(dateStr);
  if (status === 'expired') return `PÃ©rimÃ© il y a ${Math.abs(diff)}j`;
  if (status === 'soon')    return `Dans ${diff}j`;
  return `OK â€” ${diff}j`;
}

function statusOrder(s) { return s === 'expired' ? 0 : s === 'soon' ? 1 : 2; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATS HEADER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
  let expired = 0, soon = 0;
  meds.forEach(m => {
    const s = getStatus(m.date);
    if (s === 'expired') expired++;
    if (s === 'soon')    soon++;
  });
  document.querySelector('#stat-expired .n').textContent = expired;
  document.querySelector('#stat-soon .n').textContent    = soon;
  document.querySelector('#stat-total .n').textContent   = meds.length;
  document.getElementById('badge-stock').textContent     = meds.length;

  // Compteurs lieu tabs
  LIEUX.forEach(l => {
    const el = document.getElementById('count-' + l);
    if (el) el.textContent = meds.filter(m => m.lieu === l).length;
  });
  const allEl = document.getElementById('count-all');
  if (allEl) allEl.textContent = meds.length;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GLOBAL SUMMARY (cartes par lieu)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGlobalSummary() {
  const container = document.getElementById('globalSummary');
  container.innerHTML = LIEUX.map(lieu => {
    const list = meds.filter(m => m.lieu === lieu);
    let exp = 0, soon = 0, ok = 0;
    list.forEach(m => { const s = getStatus(m.date); if(s==='expired') exp++; else if(s==='soon') soon++; else ok++; });
    return `
      <div class="summary-card">
        <div class="summary-card-title">
          <span class="dot dot-${lieu}"></span>
          ${LIEU_LABELS[lieu]} â€” ${list.length} mÃ©dicament${list.length>1?'s':''}
        </div>
        <div class="summary-card-stats">
          ${exp  ? `<div class="mini-stat danger"><div class="n">${exp}</div><div class="l">PÃ©rimÃ©s</div></div>` : ''}
          ${soon ? `<div class="mini-stat warn"><div class="n">${soon}</div><div class="l">BientÃ´t</div></div>` : ''}
          <div class="mini-stat"><div class="n">${ok}</div><div class="l">OK</div></div>
        </div>
      </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER STOCK
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStock() {
  updateStats();
  renderGlobalSummary();

  const search = document.getElementById('searchStock').value.toLowerCase();
  const sort   = document.getElementById('sortStock').value;

  let list = meds.filter(m => {
    if (!m.name.toLowerCase().includes(search)) return false;
    const s = getStatus(m.date);
    if (stockFilter !== 'all' && s !== stockFilter) return false;
    if (lieuFilter  !== 'all' && m.lieu !== lieuFilter) return false;
    return true;
  });

  list.sort((a, b) => {
    if (sort === 'status')    return statusOrder(getStatus(a.date)) - statusOrder(getStatus(b.date)) || new Date(a.date) - new Date(b.date);
    if (sort === 'date-asc')  return new Date(a.date) - new Date(b.date);
    if (sort === 'date-desc') return new Date(b.date) - new Date(a.date);
    if (sort === 'name-asc')  return a.name.localeCompare(b.name, 'fr');
    if (sort === 'name-desc') return b.name.localeCompare(a.name, 'fr');
    if (sort === 'lieu')      return LIEUX.indexOf(a.lieu) - LIEUX.indexOf(b.lieu) || new Date(a.date) - new Date(b.date);
    return 0;
  });

  const n = list.length;
  document.getElementById('stockCountLabel').textContent = `${n} mÃ©dicament${n > 1 ? 's' : ''}`;

  const tbody = document.getElementById('stockBody');
  const empty = document.getElementById('stockEmpty');

  if (list.length === 0) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  tbody.innerHTML = list.map(m => {
    const s     = getStatus(m.date);
    const badge = badgeLabel(s, m.date);
    const date  = new Date(m.date + 'T00:00:00').toLocaleDateString('fr-FR', { day:'2-digit', month:'long', year:'numeric' });
    const transferBtn = m.lieu === 'Reserve'
      ? `<button class="btn-transfer" onclick="openTransfer('${m.id}')" title="TransfÃ©rer vers VSS ou SDS">â†— TransfÃ©rer</button>`
      : '';
    return `
      <tr>
        <td class="td-name">ğŸ’Š ${esc(m.name)}</td>
        <td><span class="lieu-badge lieu-${m.lieu}">${LIEU_LABELS[m.lieu]}</span></td>
        <td class="td-date">${date}</td>
        <td><span class="med-badge badge-${s}">${badge}</span></td>
        <td><div class="td-actions">${transferBtn}<button class="med-del" onclick="deleteMed('${m.id}')" title="Supprimer">âœ•</button></div></td>
      </tr>`;
  }).join('');
}

function setStockFilter(f, btn) {
  stockFilter = f;
  document.querySelectorAll('.stock-filters .filter-pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderStock();
}

function setLieuFilter(f, btn) {
  lieuFilter = f;
  document.querySelectorAll('#lieuTabs .lieu-tab').forEach(b => {
    b.className = 'lieu-tab';
  });
  btn.classList.add('active-' + (f === 'all' ? 'all' : f));
  renderStock();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER PAR MOIS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMonth() {
  updateStats();
  const y = currentMonth.getFullYear();
  const mo = currentMonth.getMonth();

  let list = meds.filter(m => {
    const exp = new Date(m.date + 'T00:00:00');
    if (exp.getFullYear() !== y || exp.getMonth() !== mo) return false;
    if (lieuFilterMonth !== 'all' && m.lieu !== lieuFilterMonth) return false;
    return true;
  }).sort((a, b) => new Date(a.date) - new Date(b.date));

  document.getElementById('badge-month').textContent = list.length || '0';

  let expC=0, soonC=0, okC=0;
  list.forEach(m => { const s=getStatus(m.date); if(s==='expired') expC++; else if(s==='soon') soonC++; else okC++; });

  const summaryEl = document.getElementById('monthSummary');
  summaryEl.innerHTML = list.length > 0 ? [
    expC  ? `<span class="summary-chip chip-expired">ğŸ”´ ${expC} pÃ©rimÃ©${expC>1?'s':''}</span>` : '',
    soonC ? `<span class="summary-chip chip-soon">ğŸŸ  ${soonC} bientÃ´t</span>` : '',
    okC   ? `<span class="summary-chip chip-ok">ğŸŸ¢ ${okC} OK</span>` : '',
  ].join('') : '';

  const btnExport = document.getElementById('btnExport');
  const container = document.getElementById('medList');

  if (list.length === 0) {
    btnExport.style.display = 'none';
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ“…</div>
        <p>Aucun mÃ©dicament ne pÃ©rime en ${currentMonth.toLocaleDateString('fr-FR', {month:'long', year:'numeric'})}${lieuFilterMonth !== 'all' ? ' pour ' + LIEU_LABELS[lieuFilterMonth] : ''}.</p>
      </div>`;
    return;
  }

  btnExport.style.display = 'flex';
  container.innerHTML = list.map(m => {
    const s     = getStatus(m.date);
    const badge = badgeLabel(s, m.date);
    const date  = new Date(m.date + 'T00:00:00').toLocaleDateString('fr-FR', { day:'2-digit', month:'long', year:'numeric' });
    return `
      <div class="med-item ${s}">
        <div class="med-name">ğŸ’Š ${esc(m.name)}</div>
        <span class="lieu-badge lieu-${m.lieu}">${LIEU_LABELS[m.lieu]}</span>
        <div class="med-date">Exp. ${date}</div>
        <span class="med-badge badge-${s}">${badge}</span>
        <button class="med-del-round" onclick="deleteMed('${m.id}')" title="Supprimer">âœ•</button>
      </div>`;
  }).join('');
}

function setLieuFilterMonth(f, btn) {
  lieuFilterMonth = f;
  document.querySelectorAll('#lieuTabsMonth .lieu-tab').forEach(b => b.className = 'lieu-tab');
  btn.classList.add('active-' + (f === 'all' ? 'all' : f));
  renderMonth();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NAVIGATION MOIS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateMonthDisplay() {
  const label = currentMonth.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
  document.getElementById('monthLabel').textContent = label;
  const y = currentMonth.getFullYear();
  const m = String(currentMonth.getMonth() + 1).padStart(2, '0');
  document.getElementById('monthPicker').value = `${y}-${m}`;
}

function changeMonth(d) {
  currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + d, 1);
  updateMonthDisplay(); renderMonth();
}

function goToToday() { currentMonth = new Date(); updateMonthDisplay(); renderMonth(); }

function onMonthPick() {
  const v = document.getElementById('monthPicker').value;
  if (!v) return;
  const [y, m] = v.split('-');
  currentMonth = new Date(parseInt(y), parseInt(m) - 1, 1);
  updateMonthDisplay(); renderMonth();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ADD / DELETE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMed() {
  const name = document.getElementById('medName').value.trim();
  const date = document.getElementById('medDate').value;
  const lieu = document.getElementById('medLieu').value;
  if (!name || !date) { toast('Remplissez le nom et la date.', 'error'); return; }
  meds.push({ id: Date.now().toString(), name, date, lieu, qty: 1 });
  save();
  document.getElementById('medName').value = '';
  document.getElementById('medDate').value = '';
  document.getElementById('transcript').textContent = 'Appuyez sur ğŸ¤ et dites par exemple : "Doliprane 1000 pÃ©remption mars 2026"';
  document.getElementById('transcript').classList.remove('active');
  toast(`âœ“ ${name} ajoutÃ© en ${LIEU_LABELS[lieu]}`);
  if (currentTab === 'stock') renderStock(); else renderMonth();
}

function deleteMed(id) {
  const med = meds.find(m => m.id === id);
  meds = meds.filter(m => m.id !== id);
  save();
  toast(`ğŸ—‘ ${med?.name || 'MÃ©dicament'} supprimÃ©`);
  if (currentTab === 'stock') renderStock(); else renderMonth();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TRANSFERT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let transferType = 'tout'; // 'tout' ou 'partiel'

function selectTransferType(type) {
  transferType = type;
  document.getElementById('opt-tout').classList.toggle('active', type === 'tout');
  document.getElementById('opt-partiel').classList.toggle('active', type === 'partiel');
}

function openTransfer(id) {
  transferMedId = id;
  const med = meds.find(m => m.id === id);
  if (!med) return;
  const date = new Date(med.date + 'T00:00:00').toLocaleDateString('fr-FR', { day:'2-digit', month:'long', year:'numeric' });
  document.getElementById('modalMedInfo').textContent = `ğŸ’Š ${med.name} â€” Exp. ${date}`;
  document.getElementById('transferDest').value = 'VSS';
  selectTransferType('tout');
  document.getElementById('modalOverlay').classList.add('open');
}

function closeModal(e) {
  if (e.target === document.getElementById('modalOverlay')) closeModalDirect();
}

function closeModalDirect() {
  document.getElementById('modalOverlay').classList.remove('open');
  transferMedId = null;
}

function confirmTransfer() {
  const med  = meds.find(m => m.id === transferMedId);
  const dest = document.getElementById('transferDest').value;
  if (!med) return;

  // CrÃ©e une copie dans la destination si elle n'existe pas dÃ©jÃ 
  const existing = meds.find(m => m.name === med.name && m.date === med.date && m.lieu === dest);
  if (!existing) {
    meds.push({ id: Date.now().toString(), name: med.name, date: med.date, lieu: dest });
  }

  // "Tout" â†’ supprime de la RÃ©serve / "Partiel" â†’ garde en RÃ©serve
  if (transferType === 'tout') {
    meds = meds.filter(m => m.id !== transferMedId);
    toast(`â†— ${med.name} transfÃ©rÃ© vers ${LIEU_LABELS[dest]}`);
  } else {
    toast(`ğŸ“‹ ${med.name} copiÃ© vers ${LIEU_LABELS[dest]} (reste en RÃ©serve)`);
  }

  save();
  closeModalDirect();
  renderStock();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EXPORT PDF
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportPDF() {
  const label = currentMonth.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
  const lieu  = lieuFilterMonth !== 'all' ? ` â€” ${LIEU_LABELS[lieuFilterMonth]}` : '';
  document.getElementById('printSubtitle').textContent =
    `MÃ©dicaments pÃ©rimant en ${label}${lieu} â€” ImprimÃ© le ${new Date().toLocaleDateString('fr-FR')}`;
  setTimeout(() => window.print(), 100);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DICTÃ‰E VOCALE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let recognition = null, recording = false;

function initVoice() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    document.getElementById('voiceBtn').disabled = true;
    document.getElementById('voiceUnsupportedMsg').style.display = 'block';
    document.getElementById('voiceHint').style.display = 'none';
    document.getElementById('transcript').style.display = 'none';
    return;
  }
  try {
    recognition = new SR();
    recognition.lang = 'fr-FR'; recognition.continuous = false; recognition.interimResults = true;

    recognition.onresult = (e) => {
      let interim='', final='';
      for (let i=e.resultIndex; i<e.results.length; i++) {
        const t=e.results[i][0].transcript;
        if (e.results[i].isFinal) final+=t; else interim+=t;
      }
      const text = final || interim;
      document.getElementById('transcript').textContent = text;
      document.getElementById('transcript').classList.add('active');
      if (final) parseVoice(final);
    };

    recognition.onend = () => {
      recording = false;
      document.getElementById('voiceBtn').textContent = 'ğŸ¤';
      document.getElementById('voiceBtn').classList.remove('recording');
    };

    recognition.onerror = (ev) => {
      recording = false;
      document.getElementById('voiceBtn').textContent = 'ğŸ¤';
      document.getElementById('voiceBtn').classList.remove('recording');
      const msgs = { 'not-allowed':'AccÃ¨s micro refusÃ©.', 'no-speech':'Aucune parole dÃ©tectÃ©e.' };
      toast(msgs[ev.error] || 'Erreur microphone', 'error');
    };

    document.getElementById('voiceBtn').addEventListener('click', () => {
      if (recording) { recognition.stop(); return; }
      try {
        recognition.start(); recording = true;
        document.getElementById('voiceBtn').textContent = 'â¹';
        document.getElementById('voiceBtn').classList.add('recording');
        document.getElementById('transcript').textContent = 'En Ã©couteâ€¦';
        document.getElementById('transcript').classList.add('active');
      } catch(e) { toast('Impossible de dÃ©marrer le microphone.', 'error'); }
    });
  } catch(e) {
    document.getElementById('voiceBtn').disabled = true;
    document.getElementById('voiceUnsupportedMsg').style.display = 'block';
  }
}

initVoice();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PARSING VOIX
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MONTHS_FR = {
  janvier:1, fÃ©vrier:2, fevrier:2, mars:3, avril:4, mai:5, juin:6,
  juillet:7, aoÃ»t:8, aout:8, septembre:9, octobre:10, novembre:11, dÃ©cembre:12, decembre:12
};

function parseVoice(text) {
  const t = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  let year=null, month=null, day=1;
  let dateStartIndex = -1;

  const separators = ['date de peremption','peremption','expire le','expire en','expire','perime le','perime en','perime','jusqu au'];
  let sepIndex=-1, sepLength=0;
  for (const sep of separators) {
    const idx = t.indexOf(sep);
    if (idx > 1) { sepIndex=idx; sepLength=sep.length; break; }
  }

  const reMonthYear = /(\d{1,2}\s+)?(janvier|fevrier|mars|avril|mai|juin|juillet|aout|septembre|octobre|novembre|decembre)\s+(\d{4})/;
  const reSlash = /(\d{1,2})[\/\-](\d{4})/;

  const searchZone = sepIndex >= 0 ? t.slice(sepIndex) : t;
  const searchZoneOffset = sepIndex >= 0 ? sepIndex : 0;

  const m1 = searchZone.match(reMonthYear);
  if (m1) {
    month = MONTHS_FR[m1[2]]; year = parseInt(m1[3]);
    day   = m1[1] ? parseInt(m1[1]) : new Date(year, month, 0).getDate();
    dateStartIndex = searchZoneOffset + searchZone.indexOf(m1[0]);
  }

  if (!month) {
    const m2 = searchZone.match(reSlash);
    if (m2) {
      month = parseInt(m2[1]); year = parseInt(m2[2]);
      day   = new Date(year, month, 0).getDate();
      dateStartIndex = searchZoneOffset + searchZone.indexOf(m2[0]);
    }
  }

  let cutAt = sepIndex >= 0 ? sepIndex : (dateStartIndex >= 0 ? dateStartIndex : -1);
  let name = cutAt > 0 ? text.slice(0, cutAt) : text;
  name = name.replace(/\s+(le|la|les|du|de|en|au|pour|avec|et)\s*$/i,'').replace(/[,;:\-]+$/,'').replace(/\s+/g,' ').trim();
  if (name) name = name.charAt(0).toUpperCase() + name.slice(1);
  if (name) document.getElementById('medName').value = name;

  if (year && month) {
    document.getElementById('medDate').value = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    toast(`ğŸ¤ "${name}" â€” ${String(month).padStart(2,'0')}/${year}`);
  } else if (name) {
    toast(`ğŸ¤ Nom : "${name}" â€” VÃ©rifiez la date`);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SERVICE WORKER (PWA)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/P-remptions-/service-worker.js')
      .catch(err => console.log('SW non enregistrÃ© :', err));
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateMonthDisplay();
renderStock();
</script>
</body>
</html>
